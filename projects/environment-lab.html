<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í™˜ê²½ ì„¼ì„œ ëª¨ë‹ˆí„°</title>
    
    <link rel="stylesheet" href="../css/style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .sensor-readout-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .sensor-readout { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; text-align: center; }
        .sensor-readout h3 { margin-top: 0; font-size: 1.2em; color: #495057; }
        .sensor-readout .value { font-size: 2.5em; font-weight: bold; color: #007BFF; }
        /* â–¼â–¼â–¼ ê·¸ë˜í”„ ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ ì¶”ê°€ â–¼â–¼â–¼ */
        .graph-controls { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; margin-bottom: 10px; }
        .graph-controls span { font-weight: bold; }
        .graph-controls select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <a href="../index.html">&laquo; ë©”ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a>
                <h1>í™˜ê²½ ì„¼ì„œ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°</h1>
                <p>ìƒíƒœ: <span id="status">ì—°ê²° ëŒ€ê¸°</span></p>
            </div>
            <div class="header-controls">
                <button id="connectBleButton" class="ble-button">ì•„ë‘ì´ë…¸ ì—°ê²°</button>
                <button id="disconnectBleButton" class="ble-button" style="display:none; background-color:#6c757d;">ì—°ê²° í•´ì œ</button>
            </div>
        </div>

        <div class="table-header">
              <h2>ì‹¤ì‹œê°„ í˜„í™©</h2>
              <div class="table-controls">
                  <button id="recordButton" disabled>ì¸¡ì • ì‹œì‘</button>
                  <span>ìƒ˜í”Œë§ ì†ë„:</span>
                  <select id="samplingRateSelect">
                      <option value="1000" selected>1s</option>
                      <option value="2000">2s</option>
                      <option value="5000">5s</option>
                  </select>
                  </div>
        </div>
        
        <div class="sensor-readout-grid">
            <div class="sensor-readout">
                <h3>ğŸŒ¡ï¸ ì˜¨ë„</h3>
                <p><span id="temp-value" class="value">--</span> Â°C</p>
            </div>
            <div class="sensor-readout">
                <h3>ğŸ’§ ìŠµë„</h3>
                <p><span id="humidity-value" class="value">--</span> %</p>
            </div>
            <div class="sensor-readout">
                <h3>ğŸ’¨ ì••ë ¥</h3>
                <p><span id="pressure-value" class="value">--</span> kPa</p>
            </div>
            <div class="sensor-readout">
                <h3>â˜€ï¸ ì¡°ë„</h3>
                <p><span id="light-value" class="value">--</span></p>
            </div>
        </div>

        <div class="main-layout">
            <div class="content-column">
                <h2>ì‹¤ì‹œê°„ ë°ì´í„° ë¡œê·¸</h2>
                <div class="table-container">
                    <table id="historyTable">
                        <thead><tr><th>Time (s)</th><th>ì˜¨ë„</th><th>ìŠµë„</th><th>ì••ë ¥</th><th>ì¡°ë„</th></tr></thead>
                        <tbody id="historyTbody"></tbody>
                    </table>
                </div>
            </div>
            <div class="content-column">
                <h2>ì‹¤ì‹œê°„ ë³€í™” ê·¸ë˜í”„</h2>
                <div class="graph-controls">
                    <span>Xì¶•:</span>
                    <select id="xAxisSelect">
                        <option value="time" selected>ì‹œê°„</option>
                        <option value="temp">ì˜¨ë„</option>
                        <option value="humidity">ìŠµë„</option>
                        <option value="pressure">ì••ë ¥</option>
                        <option value="light">ì¡°ë„</option>
                    </select>
                    <span>Yì¶•:</span>
                    <select id="yAxisSelect">
                        <option value="time">ì‹œê°„</option>
                        <option value="temp" selected>ì˜¨ë„</option>
                        <option value="humidity">ìŠµë„</option>
                        <option value="pressure">ì••ë ¥</option>
                        <option value="light">ì¡°ë„</option>
                    </select>
                </div>
                <div class="chart-container" style="height: 455px;"><canvas id="myChart"></canvas></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. UI ìš”ì†Œ ë° ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ ---
        const connectBleButton = document.getElementById('connectBleButton');
        const disconnectBleButton = document.getElementById('disconnectBleButton');
        const statusSpan = document.getElementById('status');
        const tempValue = document.getElementById('temp-value');
        const humidityValue = document.getElementById('humidity-value');
        const pressureValue = document.getElementById('pressure-value');
        const lightValue = document.getElementById('light-value');
        const historyTbody = document.getElementById('historyTbody');
        const chartCanvas = document.getElementById('myChart');
        const samplingRateSelect = document.getElementById('samplingRateSelect');
        const recordButton = document.getElementById('recordButton');
        
        // â–¼â–¼â–¼ JS ìˆ˜ì •: ë“œë¡­ë‹¤ìš´ UI ìš”ì†Œ ì¶”ê°€ â–¼â–¼â–¼
        const xAxisSelect = document.getElementById('xAxisSelect');
        const yAxisSelect = document.getElementById('yAxisSelect');
        
        let bleDevice, commandCharacteristic;
        let recordedData = [];
        let myChart;
        let envIntervalMs = 1000;
        let isRecording = false;
        
        const UART_SERVICE_UUID = "19b10000-e8f2-537e-4f6c-d104768a1214";
        const UART_TX_CHAR_UUID = "19b10001-e8f2-537e-4f6c-d104768a1214";
        const UART_CMD_CHAR_UUID = "19b10002-e8f2-537e-4f6c-d104768a1214";
        
        // â–¼â–¼â–¼ JS ìˆ˜ì •: ì¶• ì´ë¦„ê³¼ ë‹¨ìœ„ë¥¼ ê´€ë¦¬í•˜ëŠ” ê°ì²´ ì¶”ê°€ â–¼â–¼â–¼
        const SENSOR_UNITS = {
            time: 'ì‹œê°„ (s)',
            temp: 'ì˜¨ë„ (Â°C)',
            humidity: 'ìŠµë„ (%)',
            pressure: 'ì••ë ¥ (kPa)',
            light: 'ì¡°ë„'
        };

        // --- 2. ì°¨íŠ¸ ì´ˆê¸°í™” ---
        // â–¼â–¼â–¼ JS ìˆ˜ì •: ì°¨íŠ¸ íƒ€ì…ì„ scatterë¡œ ë³€ê²½í•˜ê³  ë‹¨ì¼ ë°ì´í„°ì…‹ìœ¼ë¡œ ì´ˆê¸°í™” â–¼â–¼â–¼
        myChart = new Chart(chartCanvas, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'ì¸¡ì • ë°ì´í„°',
                    data: [], // ë°ì´í„°ëŠ” {x: value, y: value} í˜•íƒœì˜ ê°ì²´ ë°°ì—´
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    showLine: true, // ì ë“¤ì„ ì„ ìœ¼ë¡œ ì—°ê²°
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: { display: true, text: SENSOR_UNITS[xAxisSelect.value] } // ì´ˆê¸° Xì¶• ì œëª©
                    },
                    y: {
                        title: { display: true, text: SENSOR_UNITS[yAxisSelect.value] } // ì´ˆê¸° Yì¶• ì œëª©
                    }
                }
            }
        });

        // --- 3. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ---
        connectBleButton.addEventListener('click', connectBLE);
        disconnectBleButton.addEventListener('click', disconnectBLE);
        samplingRateSelect.addEventListener('change', handleRateChange);
        recordButton.addEventListener('click', toggleRecording);
        // â–¼â–¼â–¼ JS ìˆ˜ì •: ì²´í¬ë°•ìŠ¤ ë¦¬ìŠ¤ë„ˆë¥¼ ë“œë¡­ë‹¤ìš´ ë¦¬ìŠ¤ë„ˆë¡œ ë³€ê²½ â–¼â–¼â–¼
        xAxisSelect.addEventListener('change', updateChartAxes);
        yAxisSelect.addEventListener('change', updateChartAxes);


        // --- 4. í•¨ìˆ˜ ì •ì˜ ---
        // (connectBLE, disconnectBLE, onDisconnected, handleRateChange í•¨ìˆ˜ëŠ” ì´ì „ê³¼ ë™ì¼)
        async function connectBLE() {
            try {
                const device = await navigator.bluetooth.requestDevice({ filters: [{ services: [UART_SERVICE_UUID], namePrefix: 'Sensor-' }] });
                bleDevice = device;
                device.addEventListener('gattserverdisconnected', onDisconnected);
                statusSpan.textContent = `ì—°ê²° ì¤‘: ${device.name}`;
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(UART_SERVICE_UUID);
                const dataCharacteristic = await service.getCharacteristic(UART_TX_CHAR_UUID);
                commandCharacteristic = await service.getCharacteristic(UART_CMD_CHAR_UUID);
                await dataCharacteristic.startNotifications();
                dataCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);
                await commandCharacteristic.writeValue(new TextEncoder().encode("START:ENV"));
                handleRateChange();
                statusSpan.textContent = `ì—°ê²°ë¨: ${device.name}`;
                connectBleButton.style.display = 'none';
                disconnectBleButton.style.display = 'inline-block';
                recordButton.disabled = false;
            } catch(error) {
                statusSpan.textContent = 'ì—°ê²° ì‹¤íŒ¨';
                console.error(error);
            }
        }
        async function disconnectBLE() {
            if (bleDevice && bleDevice.gatt.connected) {
                if(isRecording) toggleRecording();
                await commandCharacteristic.writeValue(new TextEncoder().encode("STOP"));
                bleDevice.gatt.disconnect();
            }
        }
        function onDisconnected() {
            statusSpan.textContent = 'ì—°ê²° í•´ì œë¨';
            connectBleButton.style.display = 'inline-block';
            disconnectBleButton.style.display = 'none';
            recordButton.disabled = true;
            tempValue.textContent = '--'; humidityValue.textContent = '--'; pressureValue.textContent = '--'; lightValue.textContent = '--';
        }
        async function handleRateChange() {
            envIntervalMs = parseInt(samplingRateSelect.value);
            if (bleDevice && bleDevice.gatt.connected) {
                await commandCharacteristic.writeValue(new TextEncoder().encode(`SET_ENV_RATE:${envIntervalMs}`));
            }
        }

        // â–¼â–¼â–¼ JS ìˆ˜ì •: ì¸¡ì • ì‹œì‘/ì¤‘ì§€ ì‹œ ì°¨íŠ¸ ë°ì´í„° ì´ˆê¸°í™” ë°©ì‹ ë³€ê²½ â–¼â–¼â–¼
        function toggleRecording() {
            isRecording = !isRecording;
            if (isRecording) {
                recordedData = [];
                historyTbody.innerHTML = '';
                myChart.data.datasets[0].data = []; // scatter ì°¨íŠ¸ ë°ì´í„° ì´ˆê¸°í™”
                myChart.update('none');

                recordButton.textContent = 'ì¸¡ì • ì¤‘ì§€';
                recordButton.style.backgroundColor = '#DC3545';
                statusSpan.textContent = `ì¸¡ì • ì¤‘... (${envIntervalMs/1000}s ê°„ê²©)`;
            } else {
                recordButton.textContent = 'ì¸¡ì • ì‹œì‘';
                recordButton.style.backgroundColor = '#28A745';
                statusSpan.textContent = `ì¸¡ì • ì™„ë£Œ (ì´ ${recordedData.length}ê°œ ë°ì´í„°)`;
            }
        }

        // â–¼â–¼â–¼ JS ì‹ ê·œ: ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì‹œ í˜¸ì¶œë  í•¨ìˆ˜ â–¼â–¼â–¼
        function updateChartAxes() {
            const xKey = xAxisSelect.value;
            const yKey = yAxisSelect.value;

            // 1. ì¶• ì œëª©ê³¼ ë°ì´í„°ì…‹ ë¼ë²¨ ì—…ë°ì´íŠ¸
            myChart.options.scales.x.title.text = SENSOR_UNITS[xKey];
            myChart.options.scales.y.title.text = SENSOR_UNITS[yKey];
            myChart.data.datasets[0].label = `${SENSOR_UNITS[yKey]} vs ${SENSOR_UNITS[xKey]}`;

            // 2. ì´ë¯¸ ê¸°ë¡ëœ ë°ì´í„°ë¡œ ì°¨íŠ¸ ë°ì´í„° ì¬ìƒì„±
            const newData = recordedData.map(d => ({
                x: d[xKey],
                y: d[yKey]
            }));
            myChart.data.datasets[0].data = newData;

            // 3. ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            myChart.update();
        }

        // â–¼â–¼â–¼ JS ìˆ˜ì •: ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹  ì‹œ ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ë°©ì‹ ë³€ê²½ â–¼â–¼â–¼
        function handleNotifications(event) {
            const value = new TextDecoder().decode(event.target.value);
            try {
                const json = JSON.parse(value);
                if (json.type === 'env') {
                    const data = json.data;

                    tempValue.textContent = data.temp.toFixed(2);
                    humidityValue.textContent = data.humidity.toFixed(2);
                    pressureValue.textContent = data.pressure.toFixed(2);
                    lightValue.textContent = data.light;
                    
                    if (isRecording) {
                        const elapsedTime = (recordedData.length * (envIntervalMs / 1000.0));
                        const newDataPoint = { time: parseFloat(elapsedTime.toFixed(3)), ...data };
                        recordedData.push(newDataPoint);
                        
                        const newRow = historyTbody.insertRow(0);
                        newRow.innerHTML = `<td>${newDataPoint.time.toFixed(1)}</td><td>${data.temp.toFixed(2)}</td><td>${data.humidity.toFixed(2)}</td><td>${data.pressure.toFixed(2)}</td><td>${data.light}</td>`;

                        // í˜„ì¬ ë“œë¡­ë‹¤ìš´ì—ì„œ ì„ íƒëœ ì¶•ì— ë§ëŠ” ë°ì´í„°ë¥¼ ì°¨íŠ¸ì— ì¶”ê°€
                        const xKey = xAxisSelect.value;
                        const yKey = yAxisSelect.value;
                        myChart.data.datasets[0].data.push({
                            x: newDataPoint[xKey],
                            y: newDataPoint[yKey]
                        });
                        
                        // ì°¨íŠ¸ì— í‘œì‹œí•  ë°ì´í„° ê°œìˆ˜ ì œí•œ (ì˜ˆ: 60ê°œ)
                        if (myChart.data.datasets[0].data.length > 60) {
                            myChart.data.datasets[0].data.shift();
                        }
                        myChart.update('none');
                    }
                }
            } catch(e) {
                console.error("Invalid JSON:", value);
            }
        }
    </script>
</body>
</html>
