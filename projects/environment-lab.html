<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>환경 센서 모니터</title>
    
    <link rel="stylesheet" href="../css/style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .sensor-readout-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .sensor-readout { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; text-align: center; }
        .sensor-readout h3 { margin-top: 0; font-size: 1.2em; color: #495057; }
        .sensor-readout .value { font-size: 2.5em; font-weight: bold; color: #007BFF; }
        .checkbox-group { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .checkbox-group label { display: flex; align-items: center; gap: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <a href="../index.html">&laquo; 메인 페이지로 돌아가기</a>
                <h1>환경 센서 실시간 모니터</h1>
                <p>상태: <span id="status">연결 대기</span></p>
            </div>
            <div class="header-controls">
                <button id="connectBleButton" class="ble-button">아두이노 연결</button>
                <button id="disconnectBleButton" class="ble-button" style="display:none; background-color:#6c757d;">연결 해제</button>
            </div>
        </div>

        <div class="table-header">
             <h2>실시간 현황</h2>
             <div class="table-controls">
                <span>샘플링 속도:</span>
                <select id="samplingRateSelect">
                    <option value="1000" selected>1s</option>
                    <option value="2000">2s</option>
                    <option value="5000">5s</option>
                </select>
            </div>
        </div>
        
        <div class="sensor-readout-grid">
            <div class="sensor-readout">
                <h3>🌡️ 온도</h3>
                <p><span id="temp-value" class="value">--</span> °C</p>
            </div>
            <div class="sensor-readout">
                <h3>💧 습도</h3>
                <p><span id="humidity-value" class="value">--</span> %</p>
            </div>
            <div class="sensor-readout">
                <h3>💨 압력</h3>
                <p><span id="pressure-value" class="value">--</span> kPa</p>
            </div>
            <div class="sensor-readout">
                <h3>☀️ 조도</h3>
                <p><span id="light-value" class="value">--</span></p>
            </div>
        </div>

        <div class="main-layout">
            <div class="content-column">
                <h2>실시간 데이터 로그</h2>
                <div class="table-container">
                    <table id="historyTable">
                        <thead><tr><th>Time (s)</th><th>온도</th><th>습도</th><th>압력</th><th>조도</th></tr></thead>
                        <tbody id="historyTbody"></tbody>
                    </table>
                </div>
            </div>
            <div class="content-column">
                <h2>실시간 변화 그래프</h2>
                <div class="graph-controls">
                    <span>X축:</span>
                    <select id="xAxisSelect">
                        <option value="time">시간 (s)</option>
                        <option value="temp">온도 (°C)</option>
                        <option value="humidity">습도 (%)</option>
                        <option value="pressure">압력 (kPa)</option>
                        <option value="light">조도</option>
                    </select>
                    <span>Y축:</span>
                    <select id="yAxisSelect">
                        <option value="time">시간 (s)</option>
                        <option value="temp" selected>온도 (°C)</option>
                        <option value="humidity">습도 (%)</option>
                        <option value="pressure">압력 (kPa)</option>
                        <option value="light">조도</option>
                    </select>
                </div>
                <div class="chart-container" style="height: 455px;"><canvas id="myChart"></canvas></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. UI 요소 및 전역 변수 선언 ---
        const connectBleButton = document.getElementById('connectBleButton');
        const disconnectBleButton = document.getElementById('disconnectBleButton');
        const statusSpan = document.getElementById('status');
        const tempValue = document.getElementById('temp-value');
        const humidityValue = document.getElementById('humidity-value');
        const pressureValue = document.getElementById('pressure-value');
        const lightValue = document.getElementById('light-value');
        const historyTbody = document.getElementById('historyTbody');
        const chartCanvas = document.getElementById('myChart');
        const xAxisSelect = document.getElementById('xAxisSelect'); // 새로 추가
        const yAxisSelect = document.getElementById('yAxisSelect'); // 새로 추가
        const samplingRateSelect = document.getElementById('samplingRateSelect');
        
        let bleDevice, commandCharacteristic;
        let recordedData = [];
        let myChart;
        let envIntervalMs = 1000;
        
        const UART_SERVICE_UUID = "19b10000-e8f2-537e-4f6c-d104768a1214";
        const UART_TX_CHAR_UUID = "19b10001-e8f2-537e-4f6c-d104768a1214";
        const UART_CMD_CHAR_UUID = "19b10002-e8f2-537e-4f6c-d104768a1214";

        // --- 2. 차트 초기화 ---
        myChart = new Chart(chartCanvas, {
            type: 'scatter', // 라인 차트 대신 산점도(scatter)로 변경
            data: {
                datasets: [{
                    label: '환경 데이터',
                    data: [],
                    backgroundColor: 'rgba(54, 162, 235, 0.6)'
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'X축' } }, y: { title: { display: true, text: 'Y축' } } } }
        });

        // --- 3. 이벤트 리스너 연결 ---
        connectBleButton.addEventListener('click', connectBLE);
        disconnectBleButton.addEventListener('click', disconnectBLE);
        samplingRateSelect.addEventListener('change', handleRateChange);
        xAxisSelect.addEventListener('change', updateGraph);
        yAxisSelect.addEventListener('change', updateGraph);

        // --- 4. 함수 정의 ---
        async function connectBLE() {
            try {
                const device = await navigator.bluetooth.requestDevice({ filters: [{ services: [UART_SERVICE_UUID], namePrefix: 'Sensor-' }] });
                bleDevice = device;
                device.addEventListener('gattserverdisconnected', onDisconnected);
                statusSpan.textContent = `연결 중: ${device.name}`;
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(UART_SERVICE_UUID);
                const dataCharacteristic = await service.getCharacteristic(UART_TX_CHAR_UUID);
                commandCharacteristic = await service.getCharacteristic(UART_CMD_CHAR_UUID);
                
                await dataCharacteristic.startNotifications();
                dataCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);
                
                await commandCharacteristic.writeValue(new TextEncoder().encode("START:ENV"));
                handleRateChange(); // 연결 시 현재 선택된 속도 전송
                
                statusSpan.textContent = `연결됨: ${device.name}`;
                connectBleButton.style.display = 'none';
                disconnectBleButton.style.display = 'inline-block';
            } catch(error) {
                statusSpan.textContent = '연결 실패';
                console.error(error);
            }
        }
        
        async function disconnectBLE() {
            if (bleDevice && bleDevice.gatt.connected) {
                await commandCharacteristic.writeValue(new TextEncoder().encode("STOP"));
                bleDevice.gatt.disconnect();
            }
        }
        
        function onDisconnected() {
            statusSpan.textContent = '연결 해제됨';
            connectBleButton.style.display = 'inline-block';
            disconnectBleButton.style.display = 'none';
            // 값 초기화
            tempValue.textContent = '--';
            humidityValue.textContent = '--';
            pressureValue.textContent = '--';
            lightValue.textContent = '--';
        }

        async function handleRateChange() {
            envIntervalMs = parseInt(samplingRateSelect.value);
            if (bleDevice && bleDevice.gatt.connected) {
                await commandCharacteristic.writeValue(new TextEncoder().encode(`SET_ENV_RATE:${envIntervalMs}`));
            }
        }

        function handleNotifications(event) {
            const value = new TextDecoder().decode(event.target.value);
            try {
                const json = JSON.parse(value);
                if (json.type === 'env') {
                    const data = json.data;
                    const elapsedTime = (recordedData.length * (envIntervalMs/1000.0)).toFixed(2);

                    // 1. 현재 값 업데이트
                    tempValue.textContent = data.temp.toFixed(2);
                    humidityValue.textContent = data.humidity.toFixed(2);
                    pressureValue.textContent = data.pressure.toFixed(2);
                    lightValue.textContent = data.light;
                    
                    const newData = {
                        time: parseFloat(elapsedTime),
                        temp: data.temp,
                        humidity: data.humidity,
                        pressure: data.pressure,
                        light: data.light
                    };
                    recordedData.push(newData);
                    
                    // 2. 데이터가 너무 많아지면 앞부분을 잘라냄 (최대 100개)
                    if (recordedData.length > 100) {
                        recordedData.shift();
                    }
                    
                    updateTable();
                    updateGraph();
                }
            } catch(e) {
                console.error("Invalid JSON:", value);
            }
        }

        // --- 🔻 핵심 변경 사항 2: 테이블과 그래프 업데이트 로직 분리 🔻 ---
        function updateTable() {
            historyTbody.innerHTML = ''; // 테이블 비우기
            // 최신 데이터가 위로 오도록 역순으로 표시
            [...recordedData].reverse().forEach(data => {
                const newRow = historyTbody.insertRow();
                newRow.innerHTML = `<td>${data.time.toFixed(2)}</td><td>${data.temp.toFixed(2)}</td><td>${data.humidity.toFixed(2)}</td><td>${data.pressure.toFixed(2)}</td><td>${data.light}</td>`;
            });
        }

        function updateGraph() {
            if (!myChart || recordedData.length === 0) return;
            
            const xAxisKey = xAxisSelect.value;
            const yAxisKey = yAxisSelect.value;

            if (xAxisKey === yAxisKey) {
                myChart.data.datasets[0].data = [];
            } else {
                const graphData = recordedData.map(d => ({
                    x: d[xAxisKey],
                    y: d[yAxisKey]
                }));
                myChart.data.datasets[0].data = graphData;
            }

            // X축과 Y축 라벨 업데이트
            myChart.options.scales.x.title.text = xAxisSelect.selectedOptions[0].text;
            myChart.options.scales.y.title.text = yAxisSelect.selectedOptions[0].text;

            myChart.update('none');
        }
    </script>
</body>
</html>
