<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í™˜ê²½ ì„¼ì„œ ëª¨ë‹ˆí„°</title>
    
    <link rel="stylesheet" href="../css/style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* ì´ í˜ì´ì§€ì—ë§Œ ì ìš©ë˜ëŠ” ì¶”ê°€ ìŠ¤íƒ€ì¼ */
        .sensor-readout-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .sensor-readout {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        .sensor-readout h3 {
            margin-top: 0;
            font-size: 1.2em;
            color: #495057;
        }
        .sensor-readout .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #007BFF;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="../index.html">&laquo; ë©”ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a>
        <h1>í™˜ê²½ ì„¼ì„œ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°</h1>
        <p>ìƒíƒœ: <span id="status">ì—°ê²° ëŒ€ê¸°</span></p>
        <button id="connectBleButton" class="ble-button">ì•„ë‘ì´ë…¸ ì—°ê²°</button>
        <button id="disconnectBleButton" class="ble-button" style="display:none; background-color:#6c757d;">ì—°ê²° í•´ì œ</button>
        
        <div class="sensor-readout-grid">
            <div class="sensor-readout">
                <h3>ğŸŒ¡ï¸ ì˜¨ë„</h3>
                <p><span id="temp-value" class="value">--</span> Â°C</p>
            </div>
            <div class="sensor-readout">
                <h3>ğŸ’§ ìŠµë„</h3>
                <p><span id="humidity-value" class="value">--</span> %</p>
            </div>
            <div class="sensor-readout">
                <h3>â˜€ï¸ ì¡°ë„</h3>
                <p><span id="light-value" class="value">--</span></p>
            </div>
        </div>

        <div class="main-layout">
            <div class="content-column">
                <h2>ì‹¤ì‹œê°„ ë°ì´í„° ë¡œê·¸</h2>
                <div class="table-container">
                    <table id="historyTable">
                        <thead><tr><th>Time (s)</th><th>ì˜¨ë„ (Â°C)</th><th>ìŠµë„ (%)</th><th>ì¡°ë„</th></tr></thead>
                        <tbody id="historyTbody"></tbody>
                    </table>
                </div>
            </div>
            <div class="content-column">
                <h2>ì‹¤ì‹œê°„ ë³€í™” ê·¸ë˜í”„</h2>
                <div class="chart-container" style="height: 485px;"><canvas id="myChart"></canvas></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. UI ìš”ì†Œ ë° ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ ---
        const connectBleButton = document.getElementById('connectBleButton');
        const disconnectBleButton = document.getElementById('disconnectBleButton');
        const statusSpan = document.getElementById('status');
        const tempValue = document.getElementById('temp-value');
        const humidityValue = document.getElementById('humidity-value');
        const lightValue = document.getElementById('light-value');
        const historyTbody = document.getElementById('historyTbody');
        const chartCanvas = document.getElementById('myChart');
        
        let bleDevice, commandCharacteristic;
        let recordedData = [];
        let myChart;
        
        const UART_SERVICE_UUID = "19b10000-e8f2-537e-4f6c-d104768a1214";
        const UART_TX_CHAR_UUID = "19b10001-e8f2-537e-4f6c-d104768a1214";
        const UART_CMD_CHAR_UUID = "19b10002-e8f2-537e-4f6c-d104768a1214";

        // --- 2. ì°¨íŠ¸ ì´ˆê¸°í™” ---
        myChart = new Chart(chartCanvas, {
            type: 'line',
            data: {
                labels: [], // Xì¶• (ì‹œê°„)
                datasets: [
                    { label: 'ì˜¨ë„ (Â°C)', data: [], borderColor: 'rgba(255, 99, 132, 1)', yAxisID: 'y' },
                    { label: 'ìŠµë„ (%)', data: [], borderColor: 'rgba(54, 162, 235, 1)', yAxisID: 'y' },
                    { label: 'ì¡°ë„', data: [], borderColor: 'rgba(255, 206, 86, 1)', yAxisID: 'y1', hidden: true } // ì¡°ë„ëŠ” ìŠ¤ì¼€ì¼ì´ ë‹¬ë¼ ë³„ë„ ì¶• ì‚¬ìš©
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: 'ì‹œê°„ (s)' } },
                    y: { type: 'linear', position: 'left', title: { display: true, text: 'ì˜¨ë„/ìŠµë„' } },
                    y1: { type: 'linear', position: 'right', title: { display: true, text: 'ì¡°ë„' }, grid: { drawOnChartArea: false } }
                }
            }
        });

        // --- 3. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ---
        connectBleButton.addEventListener('click', async () => {
            try {
                const device = await navigator.bluetooth.requestDevice({ filters: [{ services: [UART_SERVICE_UUID], namePrefix: 'Sensor-' }] });
                bleDevice = device;
                device.addEventListener('gattserverdisconnected', onDisconnected);
                statusSpan.textContent = `ì—°ê²° ì¤‘: ${device.name}`;
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(UART_SERVICE_UUID);
                const dataCharacteristic = await service.getCharacteristic(UART_TX_CHAR_UUID);
                commandCharacteristic = await service.getCharacteristic(UART_CMD_CHAR_UUID);
                
                await dataCharacteristic.startNotifications();
                dataCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);
                
                // ì—°ê²° ì„±ê³µ ì‹œ, 'í™˜ê²½ ì„¼ì„œ ë°ì´í„° ìš”ì²­' ëª…ë ¹ ì „ì†¡
                await commandCharacteristic.writeValue(new TextEncoder().encode("START:ENV"));
                
                statusSpan.textContent = `ì—°ê²°ë¨: ${device.name}`;
                connectBleButton.style.display = 'none';
                disconnectBleButton.style.display = 'inline-block';
            } catch(error) {
                statusSpan.textContent = 'ì—°ê²° ì‹¤íŒ¨';
                console.error(error);
            }
        });

        disconnectBleButton.addEventListener('click', async () => {
            if (bleDevice && bleDevice.gatt.connected) {
                await commandCharacteristic.writeValue(new TextEncoder().encode("STOP"));
                bleDevice.gatt.disconnect();
            }
        });

        // --- 4. í•¨ìˆ˜ ì •ì˜ ---
        function onDisconnected() {
            statusSpan.textContent = 'ì—°ê²° í•´ì œë¨';
            connectBleButton.style.display = 'inline-block';
            disconnectBleButton.style.display = 'none';
            tempValue.textContent = '--';
            humidityValue.textContent = '--';
            lightValue.textContent = '--';
        }

        function handleNotifications(event) {
            const value = new TextDecoder().decode(event.target.value);
            try {
                const json = JSON.parse(value);
                if (json.type === 'env') {
                    const data = json.data;
                    const elapsedTime = (recordedData.length * 1).toFixed(1); // 1ì´ˆ ê°„ê²©

                    // 1. í˜„ì¬ ê°’ ì—…ë°ì´íŠ¸
                    tempValue.textContent = data.temp.toFixed(2);
                    humidityValue.textContent = data.humidity.toFixed(2);
                    lightValue.textContent = data.light;

                    // 2. ë°ì´í„° ë°°ì—´ ë° í…Œì´ë¸”ì— ì¶”ê°€
                    recordedData.push(data);
                    const newRow = historyTbody.insertRow(0);
                    newRow.innerHTML = `<td>${elapsedTime}</td><td>${data.temp.toFixed(2)}</td><td>${data.humidity.toFixed(2)}</td><td>${data.light}</td>`;

                    // 3. ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
                    myChart.data.labels.push(elapsedTime);
                    myChart.data.datasets[0].data.push(data.temp);
                    myChart.data.datasets[1].data.push(data.humidity);
                    myChart.data.datasets[2].data.push(data.light);
                    
                    // ê·¸ë˜í”„ì— ë°ì´í„°ê°€ ë„ˆë¬´ ë§ì•„ì§€ë©´ ì•ë¶€ë¶„ì„ ì˜ë¼ëƒ„ (ìµœëŒ€ 60ê°œ)
                    if (myChart.data.labels.length > 60) {
                        myChart.data.labels.shift();
                        myChart.data.datasets.forEach(dataset => dataset.data.shift());
                    }
                    myChart.update('none');
                }
            } catch(e) {
                console.error("Invalid JSON:", value);
            }
        }
    </script>
</body>
</html>
