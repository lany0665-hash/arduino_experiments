<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í™˜ê²½ ì„¼ì„œ ëª¨ë‹ˆí„°</title>
    
    <link rel="stylesheet" href="../css/style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    
    <style>
        /* --- ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ë° ì„¼ì„œ í‘œì‹œ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ê³¼ ë™ì¼) --- */
        .sensor-readout-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .sensor-readout { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; text-align: center; }
        .sensor-readout h3 { margin-top: 0; font-size: 1.2em; color: #495057; }
        .sensor-readout .value { font-size: 2.5em; font-weight: bold; color: #007BFF; }
        .graph-controls { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; margin-bottom: 10px; }
        .trial-management { margin-top: 1rem; padding: 1rem; border: 1px solid #ddd; border-radius: 8px; }
        .trial-management h3 { margin-top: 0; }
        .trial-list { list-style: none; padding: 0; margin: 0; max-height: 150px; overflow-y: auto; }
        .trial-list li { display: flex; align-items: center; gap: 10px; padding: 5px; border-bottom: 1px solid #eee; }
        .trial-controls { display: flex; gap: 10px; margin-top: 10px; }
        #yAxisCheckboxes { display: flex; gap: 10px; align-items: center; border: 1px solid #ccc; padding: 5px 8px; border-radius: 4px; }
        #yAxisCheckboxes label { cursor: pointer; user-select: none; }
        .log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .log-header h2 { margin: 0; }

        /* --- â˜…â˜…â˜…â˜…â˜… ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¬ì •ì˜ (ê¸°ì¡´ê³¼ ë™ì¼) â˜…â˜…â˜…â˜…â˜… --- */
        button, .button-link {
            padding: 8px 12px; border: 1px solid #ccc; border-radius: 5px; background-color: #f0f0f0;
            color: #333; cursor: pointer; transition: background-color 0.2s, border-color 0.2s, color 0.2s;
            text-decoration: none; font-size: 0.9em; display: inline-block; text-align: center;
        }
        button:disabled, .button-link:disabled {
            background-color: #e9ecef; border-color: #ced4da; color: #adb5bd;
            cursor: not-allowed; opacity: 0.65;
        }
        button:not(:disabled):hover, .button-link:not(:disabled):hover {
            background-color: #ddd; border-color: #bbb; color: #111;
        }
        .btn-primary { background-color: #007bff; border-color: #007bff; color: white; }
        .btn-primary:not(:disabled):hover { background-color: #0056b3; border-color: #0056b3; color: white; }
        .btn-danger { background-color: #dc3545; border-color: #dc3545; color: white; }
        .btn-danger:not(:disabled):hover { background-color: #c82333; border-color: #bd2130; color: white; }
        .btn-secondary { background-color: #6c757d; border-color: #6c757d; color: white; }
        .btn-secondary:not(:disabled):hover { background-color: #5a6268; border-color: #545b62; color: white; }
        .btn-info { background-color: #17a2b8; border-color: #17a2b8; color: white; }
        .btn-info:not(:disabled):hover { background-color: #138496; border-color: #117a8b; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <a href="../index.html">&laquo; ë©”ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a>
                <h1>í™˜ê²½ ì„¼ì„œ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°</h1>
                <p>ìƒíƒœ: <span id="status">ì—°ê²° ëŒ€ê¸°</span></p>
            </div>
            <div class="header-controls">
                <button id="connectBleButton" class="ble-button">ì•„ë‘ì´ë…¸ ì—°ê²°</button>
                <button id="disconnectBleButton" class="ble-button btn-secondary" style="display:none;">ì—°ê²° í•´ì œ</button>
            </div>
        </div>

        <div class="table-header">
              <h2>ì‹¤ì‹œê°„ í˜„í™©</h2>
              <div class="table-controls">
                    <button id="recordButton" disabled>ì¸¡ì • ì‹œì‘</button>
                    <span>ìƒ˜í”Œë§ ì†ë„:</span>
                    <select id="samplingRateSelect">
                        <option value="1000" selected>1s</option>
                        <option value="2000">2s</option>
                        <option value="5000">5s</option>
                    </select>
                    <button id="downloadButton" class="btn-secondary" disabled>ì—‘ì…€ ì €ì¥</button>
              </div>
        </div>
        
        <div class="sensor-readout-grid">
            <div class="sensor-readout"><h3>ğŸŒ¡ï¸ ì˜¨ë„</h3><p><span id="temp-value" class="value">--</span> Â°C</p></div>
            <div class="sensor-readout"><h3>ğŸ’§ ìŠµë„</h3><p><span id="humidity-value" class="value">--</span> %</p></div>
            <div class="sensor-readout"><h3>ğŸ’¨ ì••ë ¥</h3><p><span id="pressure-value" class="value">--</span> kPa</p></div>
            <div class="sensor-readout"><h3>ğŸŒ«ï¸ ì¦ê¸°ì••</h3><p><span id="vapor-pressure-value" class="value">--</span> kPa</p></div>
        </div>

        <div class="main-layout">
            <div class="content-column">
                
                <div class="log-header">
                    <h2>ë°ì´í„° ë¡œê·¸ (í˜„ì¬ ì‘ì—…)</h2>
                    <button id="copyAndGoButton" class="btn-info" disabled>
                        ì§€ëŠ¥í˜• ê³¼í•™ì‹¤ on ìœ¼ë¡œ ë°ì´í„° ë³´ë‚´ê¸°
                    </button>
                </div>
                <div class="table-container" id="tableContainer">
                    <table id="historyTable">
                        <thead><tr><th>Time (s)</th><th>ì˜¨ë„</th><th>ìŠµë„</th><th>ì••ë ¥</th><th>ì¦ê¸°ì••</th></tr></thead>
                        <tbody id="historyTbody"></tbody>
                    </table>
                </div>
                <div class="trial-management">
                    <h3>ì‹¤í—˜ íšŒì°¨ ê´€ë¦¬</h3>
                    <ul id="trial-list" class="trial-list"></ul>
                    <div class="trial-controls">
                        <button id="saveTrialButton" class="btn-primary" disabled>í˜„ì¬ ì¸¡ì • ì €ì¥</button>
                        <button id="clearTrialsButton" class="btn-danger">ëª¨ë“  íšŒì°¨ ì‚­ì œ</button>
                    </div>
                </div>
            </div>
            <div class="content-column">
                <h2>ì‹¤ì‹œê°„ ë³€í™” ê·¸ë˜í”„</h2>
                 <div class="graph-controls">
                    <span>Xì¶•:</span>
                    <select id="xAxisSelect">
                        <option value="time" selected>ì‹œê°„</option><option value="temp">ì˜¨ë„</option><option value="humidity">ìŠµë„</option><option value="pressure">ì••ë ¥</option>
                        <option value="vaporPressure">ì¦ê¸°ì••</option>
                    </select>
                    
                    <span>Yì¶• (ì¤‘ë³µ):</span>
                    <div id="yAxisCheckboxes">
                        <label><input type="checkbox" class="y-axis-cb" value="temp" checked> ì˜¨ë„</label>
                        <label><input type="checkbox" class="y-axis-cb" value="humidity"> ìŠµë„</label>
                        <label><input type="checkbox" class="y-axis-cb" value="pressure"> ì••ë ¥</label>
                        <label><input type="checkbox" class="y-axis-cb" value="vaporPressure"> ì¦ê¸°ì••</label>
                    </div>
                 </div>
                <div class="chart-container" style="height: 455px;"><canvas id="myChart"></canvas></div>
                
                <div class="graph-controls" style="margin-top: 10px; justify-content: flex-end;">
                    <button id="resetZoomButton" class="btn-secondary" disabled>ì¤Œ ë¦¬ì…‹</button>
                    <button id="cropButton" class="btn-secondary" disabled>ì„ íƒ ì˜ì—­ë§Œ ë‚¨ê¸°ê¸°</button>
                    <button id="deleteRangeButton" class="btn-secondary" disabled>ì„ íƒ ì˜ì—­ ì‚­ì œ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const connectBleButton = document.getElementById('connectBleButton');
        const disconnectBleButton = document.getElementById('disconnectBleButton');
        const statusSpan = document.getElementById('status');
        const tempValue = document.getElementById('temp-value');
        const humidityValue = document.getElementById('humidity-value');
        const pressureValue = document.getElementById('pressure-value');
        // â˜…â˜…â˜… ë³€ê²½ë¨ â˜…â˜…â˜… (ì¡°ë„ -> ì¦ê¸°ì••)
        const vaporPressureValue = document.getElementById('vapor-pressure-value');
        const historyTbody = document.getElementById('historyTbody');
        const chartCanvas = document.getElementById('myChart');
        const samplingRateSelect = document.getElementById('samplingRateSelect');
        const recordButton = document.getElementById('recordButton');
        const xAxisSelect = document.getElementById('xAxisSelect');
        const downloadButton = document.getElementById('downloadButton');
        const trialList = document.getElementById('trial-list');
        const saveTrialButton = document.getElementById('saveTrialButton');
        const clearTrialsButton = document.getElementById('clearTrialsButton');
        const cropButton = document.getElementById('cropButton');
        const deleteRangeButton = document.getElementById('deleteRangeButton');
        const tableContainer = document.getElementById('tableContainer');
        const resetZoomButton = document.getElementById('resetZoomButton');
        const copyAndGoButton = document.getElementById('copyAndGoButton'); 
        
        let bleDevice, commandCharacteristic;
        let recordedData = [];
        let myChart;
        let isRecording = false;
        let savedTrials = {};
        let envIntervalMs = 1000;

        const UART_SERVICE_UUID = "19b10000-e8f2-537e-4f6c-d104768a1214";
        const UART_TX_CHAR_UUID = "19b10001-e8f2-537e-4f6c-d104768a1214";
        const UART_CMD_CHAR_UUID = "19b10002-e8f2-537e-4f6c-d104768a1214";

        // â˜…â˜…â˜… ë³€ê²½ë¨ â˜…â˜…â˜… (ì¡°ë„ -> ì¦ê¸°ì••)
        const SENSOR_UNITS = { time: 'ì‹œê°„ (s)', temp: 'ì˜¨ë„ (Â°C)', humidity: 'ìŠµë„ (%)', pressure: 'ì••ë ¥ (kPa)', vaporPressure: 'ì¦ê¸°ì•• (kPa)' };
        const TRIAL_COLORS = ['rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(75, 192, 192, 0.8)', 'rgba(153, 102, 255, 0.8)', 'rgba(255, 159, 64, 0.8)', 'rgba(201, 203, 207, 0.8)'];

        // â˜…â˜…â˜… ì¶”ê°€ë¨ â˜…â˜…â˜… (ì¦ê¸°ì•• ê³„ì‚° í•¨ìˆ˜)
        function calculateVaporPressure(temp, humidity) {
            // Magnus-Tetens formula (kPa)
            const saturationPressure = 0.61094 * Math.exp((17.625 * temp) / (temp + 243.04));
            // Actual Vapor Pressure
            const actualVaporPressure = saturationPressure * (humidity / 100.0);
            return actualVaporPressure;
        }

        myChart = new Chart(chartCanvas, {
            type: 'scatter',
            data: { datasets: [] },
            options: { 
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { type: 'linear', title: { display: true, text: 'ì‹œê°„ (s)' } },
                    y: { title: { display: true, text: 'ì˜¨ë„ (Â°C)' } }
                },
                plugins: { 
                    zoom: {
                        pan: { enabled: true, mode: 'x', modifierKey: 'shift', },
                        zoom: { drag: { enabled: true, }, wheel: { enabled: true, }, mode: 'x', }
                    }
                }
            } 
        });

        window.addEventListener('load', loadTrials);
        connectBleButton.addEventListener('click', connectBLE);
        disconnectBleButton.addEventListener('click', disconnectBLE);
        samplingRateSelect.addEventListener('change', handleRateChange);
        recordButton.addEventListener('click', toggleRecording);
        xAxisSelect.addEventListener('change', redrawChart);
        document.querySelectorAll('.y-axis-cb').forEach(cb => cb.addEventListener('change', redrawChart));
        saveTrialButton.addEventListener('click', saveCurrentTrial);
        clearTrialsButton.addEventListener('click', clearAllTrials);
        cropButton.addEventListener('click', cropDataToRange);
        deleteRangeButton.addEventListener('click', deleteDataInRange);
        downloadButton.addEventListener('click', downloadData);
        resetZoomButton.addEventListener('click', () => {
            myChart.resetZoom();
        });
        copyAndGoButton.addEventListener('click', copyDataAndOpenLink);

        async function connectBLE() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'Sensor-' }],
                    optionalServices: [UART_SERVICE_UUID] 
                });
                
                bleDevice = device;
                device.addEventListener('gattserverdisconnected', onDisconnected);
                statusSpan.textContent = `ì—°ê²° ì¤‘: ${device.name}`;
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(UART_SERVICE_UUID);
                const dataCharacteristic = await service.getCharacteristic(UART_TX_CHAR_UUID);
                commandCharacteristic = await service.getCharacteristic(UART_CMD_CHAR_UUID);
                await dataCharacteristic.startNotifications();
                dataCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);
                await commandCharacteristic.writeValue(new TextEncoder().encode("START:ENV"));
                handleRateChange();
                statusSpan.textContent = `ì—°ê²°ë¨: ${device.name}`;
                connectBleButton.style.display = 'none';
                disconnectBleButton.style.display = 'inline-block';
                recordButton.disabled = false;
            } catch(error) {
                statusSpan.textContent = 'ì—°ê²° ì‹¤íŒ¨'; console.error(error);
            }
        }

        function disconnectBLE() {
            if (bleDevice && bleDevice.gatt.connected) {
                if(isRecording) toggleRecording();
                bleDevice.gatt.disconnect();
            }
        }

        function onDisconnected() {
            statusSpan.textContent = 'ì—°ê²° í•´ì œë¨';
            connectBleButton.style.display = 'inline-block';
            disconnectBleButton.style.display = 'none';
            recordButton.disabled = true;
            copyAndGoButton.disabled = true; 
        }
        
        async function handleRateChange() {
            envIntervalMs = parseInt(samplingRateSelect.value);
            if (bleDevice && bleDevice.gatt.connected) {
                await commandCharacteristic.writeValue(new TextEncoder().encode(`SET_ENV_RATE:${envIntervalMs}`));
            }
        }

        function toggleRecording() {
            isRecording = !isRecording;
            if (isRecording) {
                myChart.resetZoom(); 
                recordedData = [];
                historyTbody.innerHTML = '';
                recordButton.textContent = 'ì¸¡ì • ì¤‘ì§€'; recordButton.style.backgroundColor = '#DC3545';
                statusSpan.textContent = `ì¸¡ì • ì¤‘...`;
                downloadButton.disabled = true; 
                saveTrialButton.disabled = true; 
                cropButton.disabled = true; 
                deleteRangeButton.disabled = true;
                resetZoomButton.disabled = true;
                copyAndGoButton.disabled = true; 
                
                redrawChart();
            } else {
                recordButton.textContent = 'ì¸¡ì • ì‹œì‘'; recordButton.style.backgroundColor = '#28A745';
                statusSpan.textContent = `ì¸¡ì • ì™„ë£Œ (ì´ ${recordedData.length}ê°œ ë°ì´í„°)`;
                const isDataPresent = recordedData.length > 0;
                downloadButton.disabled = !isDataPresent; 
                saveTrialButton.disabled = !isDataPresent; 
                cropButton.disabled = !isDataPresent; 
                deleteRangeButton.disabled = !isDataPresent;
                resetZoomButton.disabled = !isDataPresent;
                copyAndGoButton.disabled = !isDataPresent; 
            }
            renderTrialList();
        }

        function handleNotifications(event) {
            const value = new TextDecoder().decode(event.target.value);
            try { 
                const json = JSON.parse(value);
                if (json.type === 'env') {
                    const data = json.data;
                    
                    // â˜…â˜…â˜… ë³€ê²½ë¨ â˜…â˜…â˜… (ì¦ê¸°ì•• ê³„ì‚° ë° í‘œì‹œ)
                    const vaporPressure = calculateVaporPressure(data.temp, data.humidity);

                    tempValue.textContent = data.temp.toFixed(2);
                    humidityValue.textContent = data.humidity.toFixed(2);
                    pressureValue.textContent = data.pressure.toFixed(2);
                    vaporPressureValue.textContent = vaporPressure.toFixed(3); // 3ìë¦¬ë¡œ í‘œì‹œ
                    
                    if (isRecording) {
                        // â˜…â˜…â˜… ë³€ê²½ë¨ â˜…â˜…â˜… (newDataPoint ê°ì²´ ìˆ˜ì •)
                        const newDataPoint = {
                            id: Date.now(),
                            time: recordedData.length * (envIntervalMs / 1000.0),
                            timestamp: json.ts,
                            temp: data.temp,
                            humidity: data.humidity,
                            pressure: data.pressure,
                            vaporPressure: vaporPressure // light ëŒ€ì‹  vaporPressure ì €ì¥
                        };
                        recordedData.push(newDataPoint);
                        
                        const newRow = historyTbody.insertRow(-1); 
                        addTableRow(newRow, newDataPoint);

                        if(historyTbody.rows.length > 500) {
                            historyTbody.deleteRow(0);
                        }
                        
                        tableContainer.scrollTop = tableContainer.scrollHeight;

                        const xKey = xAxisSelect.value;
                        const yKeys = Array.from(document.querySelectorAll('.y-axis-cb:checked')).map(cb => cb.value);

                        yKeys.forEach(yKey => {
                            const datasetLabel = `í˜„ì¬ ì¸¡ì • - ${SENSOR_UNITS[yKey].split(' ')[0]}`;
                            const dataset = myChart.data.datasets.find(ds => ds.label === datasetLabel);
                            if(dataset) {
                                dataset.data.push({ x: newDataPoint[xKey], y: newDataPoint[yKey] }); 
                            }
                        });
                        
                        myChart.update('resize'); 
                    }
                }
            } catch(e) { console.error("Invalid JSON:", value); } 
        }

        function saveCurrentTrial() {
            if (recordedData.length === 0) return alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            const trialName = prompt("ì €ì¥í•  ì‹¤í—˜ íšŒì°¨ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", `í™˜ê²½ì‹¤í—˜ ${new Date().toLocaleString()}`);
            if (trialName) {
                const trialId = `env_trial_${Date.now()}`;
                savedTrials[trialId] = { name: trialName, id: trialId, data: JSON.parse(JSON.stringify(recordedData)) };
                localStorage.setItem('env_sensor_trials', JSON.stringify(savedTrials));
                renderTrialList();
            }
        }

        function loadTrials() {
            const trials = localStorage.getItem('env_sensor_trials');
            if (trials) savedTrials = JSON.parse(trials);
            renderTrialList();
            redrawChart();
        }

        function renderTrialList() {
            trialList.innerHTML = '';
            const currentItem = document.createElement('li');
            currentItem.innerHTML = `<input type="checkbox" id="currentTrialCheckbox" checked> <label for="currentTrialCheckbox"><b>í˜„ì¬ ì¸¡ì • (${recordedData.length}ê°œ)</b></label>`;
            trialList.appendChild(currentItem);

            Object.values(savedTrials).forEach(trial => {
                const li = document.createElement('li');
                li.innerHTML = `<input type="checkbox" id="${trial.id}" class="trial-checkbox"> <label for="${trial.id}">${trial.name} (${trial.data.length}ê°œ)</label> <button class="delete-trial-btn btn-danger" data-id="${trial.id}" style="margin-left: auto;">ì‚­ì œ</button>`;
                trialList.appendChild(li);
            });
            
            trialList.querySelector('#currentTrialCheckbox').addEventListener('change', redrawChart);
            trialList.querySelectorAll('.trial-checkbox').forEach(cb => cb.addEventListener('change', redrawChart));
            trialList.querySelectorAll('.delete-trial-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const id = e.target.dataset.id;
                if (savedTrials[id] && confirm(`'${savedTrials[id].name}' íšŒì°¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    delete savedTrials[id];
                    localStorage.setItem('env_sensor_trials', JSON.stringify(savedTrials));
                    renderTrialList();
                    redrawChart();
                }
            }));
        }

        function clearAllTrials() {
            if (confirm("ì €ì¥ëœ ëª¨ë“  íšŒì°¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                savedTrials = {};
                localStorage.removeItem('env_sensor_trials');
                renderTrialList();
                redrawChart();
            }
        }
        
        function cropDataToRange() {
            if (recordedData.length === 0) return alert("í¸ì§‘í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            
            const { min: startTime, max: endTime } = myChart.scales.x;
            
            if (typeof startTime !== 'number' || typeof endTime !== 'number') {
                 return alert("ê·¸ë˜í”„ì—ì„œ ì˜ì—­ì„ ë¨¼ì € ë“œë˜ê·¸í•˜ì—¬ ì„ íƒí•´ì£¼ì„¸ìš”.");
            }
            
            const cropped = recordedData.filter(d => d.time >= startTime && d.time <= endTime);
            if (cropped.length === 0) return alert("ì„ íƒëœ ë²”ìœ„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

            const firstTime = cropped[0].time;
            recordedData = cropped.map(d => ({ ...d, time: d.time - firstTime }));
            
            alert(`ë°ì´í„°ë¥¼ í¸ì§‘í–ˆìŠµë‹ˆë‹¤. (ì´ ${recordedData.length}ê°œ)`);
            renderTable(); 
            renderTrialList(); 
            myChart.resetZoom(); 
            redrawChart(); 
        }

        function deleteDataInRange() {
            if (recordedData.length === 0) return alert("ì‚­ì œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            
            const { min: startTime, max: endTime } = myChart.scales.x;
            
            if (typeof startTime !== 'number' || typeof endTime !== 'number') {
                 return alert("ê·¸ë˜í”„ì—ì„œ ì˜ì—­ì„ ë¨¼ì € ë“œë˜ê·¸í•˜ì—¬ ì„ íƒí•´ì£¼ì„¸ìš”.");
            }
            
            const originalCount = recordedData.length;
            recordedData = recordedData.filter(d => d.time < startTime || d.time > endTime);
            const deletedCount = originalCount - recordedData.length;

            if (deletedCount === 0) return alert("ì„ íƒëœ ë²”ìœ„ì— ì‚­ì œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

            alert(`${deletedCount}ê°œì˜ ë°ì´í„°ë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.`);
            renderTable(); 
            renderTrialList(); 
            myChart.resetZoom(); 
            redrawChart(); 
        }

        function getVisibleTrials() {
            const trialsToShow = [];
            if (document.getElementById('currentTrialCheckbox')?.checked) {
                trialsToShow.push({ id: 'current', data: recordedData, name: 'í˜„ì¬ ì¸¡ì •' });
            }
            trialList.querySelectorAll('.trial-checkbox:checked').forEach(cb => {
                if(savedTrials[cb.id]) { 
                    trialsToShow.push(savedTrials[cb.id]);
                }
            });
            return trialsToShow;
        }

        function redrawChart() {
            const xKey = xAxisSelect.value;
            const yKeys = Array.from(document.querySelectorAll('.y-axis-cb:checked')).map(cb => cb.value);
            
            myChart.options.scales.x.title.text = SENSOR_UNITS[xKey];
            myChart.options.scales.y.title.text = yKeys.length === 1 ? SENSOR_UNITS[yKeys[0]] : 'ì¸¡ì •ê°’';

            myChart.data.datasets = [];
            const trialsToShow = getVisibleTrials();
            let colorIndex = 0; 

            trialsToShow.forEach((trial) => {
                if (!trial || !Array.isArray(trial.data)) {
                    console.warn("Skipping invalid trial:", trial);
                    return; 
                }
                yKeys.forEach(yKey => {
                    const color = TRIAL_COLORS[colorIndex % TRIAL_COLORS.length];
                    myChart.data.datasets.push({
                        label: `${trial.name} - ${SENSOR_UNITS[yKey].split(' ')[0]}`,
                        // â˜…â˜…â˜… ë³€ê²½ë¨ â˜…â˜…â˜… (hasProperty'light' -> 'vaporPressure' ìë™ ì²˜ë¦¬)
                        data: trial.data.filter(d => d && d.hasOwnProperty(xKey) && d.hasOwnProperty(yKey)).map(d => ({ x: d[xKey], y: d[yKey] })),
                        borderColor: color, 
                        backgroundColor: color.replace('0.8)', '0.5)'),
                        showLine: true
                    });
                    colorIndex++;
                }); 
            }); 
            myChart.update();
        }

        // â˜…â˜…â˜… ë³€ê²½ë¨ â˜…â˜…â˜… (addTableRow í•¨ìˆ˜ ìˆ˜ì •)
        function addTableRow(row, data) {
             if (data && data.time !== undefined && data.temp !== undefined && data.humidity !== undefined && data.pressure !== undefined && data.vaporPressure !== undefined) {
                 row.innerHTML = `<td>${data.time.toFixed(2)}</td><td>${data.temp.toFixed(2)}</td><td>${data.humidity.toFixed(2)}</td><td>${data.pressure.toFixed(2)}</td><td>${data.vaporPressure.toFixed(3)}</td>`;
             } else {
                 console.error("Invalid data passed to addTableRow:", data);
             }
        }
        
        function renderTable() {
            historyTbody.innerHTML = '';
            if (Array.isArray(recordedData)) {
                recordedData.forEach(d => {
                    const row = historyTbody.insertRow(-1); 
                    addTableRow(row, d);
                });
            }
            
            tableContainer.scrollTop = tableContainer.scrollHeight;
        }
        
        // â˜…â˜…â˜… ë³€ê²½ë¨ â˜…â˜…â˜… (downloadData í•¨ìˆ˜ ìˆ˜ì •)
        function downloadData() {
            if (!Array.isArray(recordedData) || recordedData.length === 0) return alert("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            let csvContent = "data:text/csv;charset=utf-8,ID,Time (s),Temperature,Humidity,Pressure,VaporPressure (kPa),Timestamp (ms)\n";
            recordedData.forEach(d => {
                 if (d && d.id !== undefined && d.time !== undefined && d.temp !== undefined && d.humidity !== undefined && d.pressure !== undefined && d.vaporPressure !== undefined && d.timestamp !== undefined) {
                     csvContent += `${d.id},${d.time.toFixed(3)},${d.temp.toFixed(2)},${d.humidity.toFixed(2)},${d.pressure.toFixed(2)},${d.vaporPressure.toFixed(3)},${d.timestamp}\n`;
                 } else {
                     console.warn("Skipping invalid data row during CSV export:", d);
                 }
            });
            const link = document.createElement("a");
            link.href = encodeURI(csvContent);
            link.download = `env_data_${new Date().toISOString()}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // â˜…â˜…â˜… ë³€ê²½ë¨ â˜…â˜…â˜… (copyDataAndOpenLink í•¨ìˆ˜ ìˆ˜ì •)
        async function copyDataAndOpenLink() {
            if (!Array.isArray(recordedData) || recordedData.length === 0) {
                alert("ë³µì‚¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì¸¡ì •ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.");
                return;
            }

            let dataString = "Time (s)\tTemperature\tHumidity\tPressure\tVaporPressure\n"; 
            recordedData.forEach(d => {
                 if (d && d.time !== undefined && d.temp !== undefined && d.humidity !== undefined && d.pressure !== undefined && d.vaporPressure !== undefined) {
                      dataString += `${d.time.toFixed(3)}\t${d.temp.toFixed(2)}\t${d.humidity.toFixed(2)}\t${d.pressure.toFixed(2)}\t${d.vaporPressure.toFixed(3)}\n`;
                 }
            });

            try {
                await navigator.clipboard.writeText(dataString);
                alert(`ë°ì´í„° ${recordedData.length}ê°œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nì§€ëŠ¥í˜• ê³¼í•™ì‹¤ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.`);
                
                window.open('https://science-on.kosac.re.kr/body/data/analysis/stdnt/main.do?rshId=ON010000008261', '_blank');

            } catch (err) {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                alert('ë°ì´í„° ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        }
        
    }); // <-- DOMContentLoaded
    </script>
</body>
</html>
