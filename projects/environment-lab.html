<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>환경 센서 모니터</title>
    
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    
    <style>
        .sensor-readout-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .sensor-readout { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; text-align: center; }
        .sensor-readout h3 { margin-top: 0; font-size: 1.2em; color: #495057; }
        .sensor-readout .value { font-size: 2.5em; font-weight: bold; color: #007BFF; }
        .graph-controls { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; margin-bottom: 10px; }
        .trial-management { margin-top: 1rem; padding: 1rem; border: 1px solid #ddd; border-radius: 8px; }
        .trial-management h3 { margin-top: 0; }
        .trial-list { list-style: none; padding: 0; margin: 0; max-height: 150px; overflow-y: auto; }
        .trial-list li { display: flex; align-items: center; gap: 10px; padding: 5px; border-bottom: 1px solid #eee; }
        .trial-controls { display: flex; gap: 10px; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <a href="../index.html">&laquo; 메인 페이지로 돌아가기</a>
                <h1>환경 센서 실시간 모니터</h1>
                <p>상태: <span id="status">연결 대기</span></p>
            </div>
            <div class="header-controls">
                <button id="connectBleButton" class="ble-button">아두이노 연결</button>
                <button id="disconnectBleButton" class="ble-button" style="display:none; background-color:#6c757d;">연결 해제</button>
            </div>
        </div>

        <div class="table-header">
              <h2>실시간 현황</h2>
              <div class="table-controls">
                  <button id="recordButton" disabled>측정 시작</button>
                  <span>샘플링 속도:</span>
                  <select id="samplingRateSelect">
                      <option value="1000" selected>1s</option>
                      <option value="2000">2s</option>
                      <option value="5000">5s</option>
                  </select>
                  <button id="downloadButton" disabled>엑셀 저장</button>
              </div>
        </div>
        
        <div class="sensor-readout-grid">
            <div class="sensor-readout"><h3>🌡️ 온도</h3><p><span id="temp-value" class="value">--</span> °C</p></div>
            <div class="sensor-readout"><h3>💧 습도</h3><p><span id="humidity-value" class="value">--</span> %</p></div>
            <div class="sensor-readout"><h3>💨 압력</h3><p><span id="pressure-value" class="value">--</span> kPa</p></div>
            <div class="sensor-readout"><h3>☀️ 조도</h3><p><span id="light-value" class="value">--</span></p></div>
        </div>

        <div class="main-layout">
            <div class="content-column">
                <h2>데이터 로그 (현재 작업)</h2>
                <div class="table-container">
                    <table id="historyTable">
                        <thead><tr><th>Time (s)</th><th>온도</th><th>습도</th><th>압력</th><th>조도</th></tr></thead>
                        <tbody id="historyTbody"></tbody>
                    </table>
                </div>
                <div class="trial-management">
                    <h3>실험 회차 관리</h3>
                    <ul id="trial-list" class="trial-list"></ul>
                    <div class="trial-controls">
                        <button id="saveTrialButton" disabled>현재 측정 저장</button>
                        <button id="clearTrialsButton">모든 회차 삭제</button>
                    </div>
                </div>
            </div>
            <div class="content-column">
                <h2>실시간 변화 그래프</h2>
                 <div class="graph-controls">
                    <span>X축:</span>
                    <select id="xAxisSelect">
                        <option value="time" selected>시간</option><option value="temp">온도</option><option value="humidity">습도</option><option value="pressure">압력</option><option value="light">조도</option>
                    </select>
                    <span>Y축:</span>
                    <select id="yAxisSelect">
                        <option value="time">시간</option><option value="temp" selected>온도</option><option value="humidity">습도</option><option value="pressure">압력</option><option value="light">조도</option>
                    </select>
                </div>
                <div class="chart-container" style="height: 455px;"><canvas id="myChart"></canvas></div>
                <div id="range-slider" style="display:none; margin-top: 10px;"></div>
                <div class="graph-controls" style="margin-top: 10px; justify-content: flex-end;">
                    <button id="cropButton" disabled>선택 영역만 남기기</button>
                    <button id="deleteRangeButton" disabled>선택 영역 삭제</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const connectBleButton = document.getElementById('connectBleButton');
        const disconnectBleButton = document.getElementById('disconnectBleButton');
        const statusSpan = document.getElementById('status');
        const tempValue = document.getElementById('temp-value');
        const humidityValue = document.getElementById('humidity-value');
        const pressureValue = document.getElementById('pressure-value');
        const lightValue = document.getElementById('light-value');
        const historyTbody = document.getElementById('historyTbody');
        const chartCanvas = document.getElementById('myChart');
        const samplingRateSelect = document.getElementById('samplingRateSelect');
        const recordButton = document.getElementById('recordButton');
        const xAxisSelect = document.getElementById('xAxisSelect');
        const yAxisSelect = document.getElementById('yAxisSelect');
        const downloadButton = document.getElementById('downloadButton');
        const trialList = document.getElementById('trial-list');
        const saveTrialButton = document.getElementById('saveTrialButton');
        const clearTrialsButton = document.getElementById('clearTrialsButton');
        const rangeSlider = document.getElementById('range-slider');
        const cropButton = document.getElementById('cropButton');
        const deleteRangeButton = document.getElementById('deleteRangeButton');
        
        let bleDevice, commandCharacteristic;
        let recordedData = [];
        let myChart;
        let isRecording = false;
        let savedTrials = {};
        let envIntervalMs = 1000;

        const UART_SERVICE_UUID = "19b10000-e8f2-537e-4f6c-d104768a1214";
        const UART_TX_CHAR_UUID = "19b10001-e8f2-537e-4f6c-d104768a1214";
        const UART_CMD_CHAR_UUID = "19b10002-e8f2-537e-4f6c-d104768a1214";

        const SENSOR_UNITS = { time: '시간 (s)', temp: '온도 (°C)', humidity: '습도 (%)', pressure: '압력 (kPa)', light: '조도' };
        const TRIAL_COLORS = ['rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(75, 192, 192, 0.8)', 'rgba(153, 102, 255, 0.8)'];

        myChart = new Chart(chartCanvas, {
            type: 'scatter',
            data: { datasets: [] },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: '시간 (s)' } }, y: { title: { display: true, text: '온도 (°C)' } } } }
        });

        window.addEventListener('load', loadTrials);
        connectBleButton.addEventListener('click', connectBLE);
        disconnectBleButton.addEventListener('click', disconnectBLE);
        samplingRateSelect.addEventListener('change', handleRateChange);
        recordButton.addEventListener('click', toggleRecording);
        xAxisSelect.addEventListener('change', redrawChart);
        yAxisSelect.addEventListener('change', redrawChart);
        saveTrialButton.addEventListener('click', saveCurrentTrial);
        clearTrialsButton.addEventListener('click', clearAllTrials);
        cropButton.addEventListener('click', cropDataToRange);
        deleteRangeButton.addEventListener('click', deleteDataInRange);
        downloadButton.addEventListener('click', downloadData);

        async function connectBLE() {
            try {
                const device = await navigator.bluetooth.requestDevice({ filters: [{ services: [UART_SERVICE_UUID], namePrefix: 'Sensor-' }] });
                bleDevice = device;
                device.addEventListener('gattserverdisconnected', onDisconnected);
                statusSpan.textContent = `연결 중: ${device.name}`;
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(UART_SERVICE_UUID);
                const dataCharacteristic = await service.getCharacteristic(UART_TX_CHAR_UUID);
                commandCharacteristic = await service.getCharacteristic(UART_CMD_CHAR_UUID);
                await dataCharacteristic.startNotifications();
                dataCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);
                await commandCharacteristic.writeValue(new TextEncoder().encode("START:ENV"));
                handleRateChange();
                statusSpan.textContent = `연결됨: ${device.name}`;
                connectBleButton.style.display = 'none';
                disconnectBleButton.style.display = 'inline-block';
                recordButton.disabled = false;
            } catch(error) {
                statusSpan.textContent = '연결 실패'; console.error(error);
            }
        }

        function disconnectBLE() {
            if (bleDevice && bleDevice.gatt.connected) {
                if(isRecording) toggleRecording();
                bleDevice.gatt.disconnect();
            }
        }

        function onDisconnected() {
            statusSpan.textContent = '연결 해제됨';
            connectBleButton.style.display = 'inline-block';
            disconnectBleButton.style.display = 'none';
            recordButton.disabled = true;
        }
        
        async function handleRateChange() {
            envIntervalMs = parseInt(samplingRateSelect.value);
            if (bleDevice && bleDevice.gatt.connected) {
                await commandCharacteristic.writeValue(new TextEncoder().encode(`SET_ENV_RATE:${envIntervalMs}`));
            }
        }

        function toggleRecording() {
            isRecording = !isRecording;
            const isDataPresent = recordedData.length > 0;
            if (isRecording) {
                recordedData = [];
                historyTbody.innerHTML = '';
                recordButton.textContent = '측정 중지'; recordButton.style.backgroundColor = '#DC3545';
                statusSpan.textContent = `측정 중...`;
                downloadButton.disabled = true; saveTrialButton.disabled = true; cropButton.disabled = true; deleteRangeButton.disabled = true;
                if(rangeSlider.noUiSlider) rangeSlider.noUiSlider.destroy();
                rangeSlider.style.display = 'none';
            } else {
                recordButton.textContent = '측정 시작'; recordButton.style.backgroundColor = '#28A745';
                statusSpan.textContent = `측정 완료 (총 ${recordedData.length}개 데이터)`;
                downloadButton.disabled = !isDataPresent; saveTrialButton.disabled = !isDataPresent; 
                cropButton.disabled = !isDataPresent; deleteRangeButton.disabled = !isDataPresent;
                if (isDataPresent) createOrUpdateSlider();
            }
            renderTrialList();
            redrawChart();
        }

        function handleNotifications(event) {
            const value = new TextDecoder().decode(event.target.value);
            try {
                const json = JSON.parse(value);
                if (json.type === 'env') {
                    const data = json.data;
                    tempValue.textContent = data.temp.toFixed(2);
                    humidityValue.textContent = data.humidity.toFixed(2);
                    pressureValue.textContent = data.pressure.toFixed(2);
                    lightValue.textContent = data.light;
                    
                    if (isRecording) {
                        const newDataPoint = {
                            id: Date.now(),
                            time: recordedData.length * (envIntervalMs / 1000.0),
                            timestamp: json.ts,
                            ...data
                        };
                        recordedData.push(newDataPoint);
                        
                        const newRow = historyTbody.insertRow(0);
                        addTableRow(newRow, newDataPoint);

                        if(historyTbody.rows.length > 500) { // [수정 1] 테이블 길이 500으로 제한
                            historyTbody.deleteRow(-1);
                        }

                        const trialsToShow = getVisibleTrials();
                        if (trialsToShow.some(t => t.id === 'current')) {
                            const dataset = myChart.data.datasets.find(ds => ds.label === '현재 측정');
                            if(dataset) {
                                const xKey = xAxisSelect.value;
                                const yKey = yAxisSelect.value;
                                dataset.data.push({ x: newDataPoint[xKey], y: newDataPoint[yKey] });
                                myChart.update('none');
                            }
                        }
                    }
                }
            } catch(e) { console.error("Invalid JSON:", value); }
        }

        function saveCurrentTrial() {
            if (recordedData.length === 0) return alert("저장할 데이터가 없습니다.");
            const trialName = prompt("저장할 실험 회차의 이름을 입력하세요:", `환경실험 ${new Date().toLocaleString()}`);
            if (trialName) {
                const trialId = `env_trial_${Date.now()}`;
                savedTrials[trialId] = { name: trialName, id: trialId, data: JSON.parse(JSON.stringify(recordedData)) };
                localStorage.setItem('env_sensor_trials', JSON.stringify(savedTrials));
                renderTrialList();
            }
        }

        function loadTrials() {
            const trials = localStorage.getItem('env_sensor_trials');
            if (trials) savedTrials = JSON.parse(trials);
            renderTrialList();
            redrawChart();
        }

        function renderTrialList() {
            trialList.innerHTML = '';
            const currentItem = document.createElement('li');
            currentItem.innerHTML = `<input type="checkbox" id="currentTrialCheckbox" checked> <label for="currentTrialCheckbox"><b>현재 측정 (${recordedData.length}개)</b></label>`;
            trialList.appendChild(currentItem);

            Object.values(savedTrials).forEach(trial => {
                const li = document.createElement('li');
                li.innerHTML = `<input type="checkbox" id="${trial.id}" class="trial-checkbox"> <label for="${trial.id}">${trial.name} (${trial.data.length}개)</label> <button class="delete-trial-btn" data-id="${trial.id}" style="margin-left: auto;">삭제</button>`;
                trialList.appendChild(li);
            });
            
            trialList.querySelector('#currentTrialCheckbox').addEventListener('change', redrawChart);
            trialList.querySelectorAll('.trial-checkbox').forEach(cb => cb.addEventListener('change', redrawChart));
            trialList.querySelectorAll('.delete-trial-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const id = e.target.dataset.id;
                if (confirm(`'${savedTrials[id].name}' 회차를 삭제하시겠습니까?`)) {
                    delete savedTrials[id];
                    localStorage.setItem('env_sensor_trials', JSON.stringify(savedTrials));
                    renderTrialList();
                    redrawChart();
                }
            }));
        }

        function clearAllTrials() {
            if (confirm("저장된 모든 회차를 삭제하시겠습니까?")) {
                savedTrials = {};
                localStorage.removeItem('env_sensor_trials');
                renderTrialList();
                redrawChart();
            }
        }
        
        function cropDataToRange() {
            if (recordedData.length === 0 || !rangeSlider.noUiSlider) return alert("편집할 데이터가 없습니다.");
            const [startTime, endTime] = rangeSlider.noUiSlider.get().map(Number);
            
            const cropped = recordedData.filter(d => d.time >= startTime && d.time <= endTime);
            if (cropped.length === 0) return alert("선택된 범위에 데이터가 없습니다.");

            const firstTime = cropped[0].time;
            recordedData = cropped.map(d => ({ ...d, time: d.time - firstTime }));
            
            alert(`데이터를 편집했습니다. (총 ${recordedData.length}개)`);
            renderTable(); renderTrialList(); redrawChart(); createOrUpdateSlider();
        }

        // [수정 2] 선택 영역 삭제 함수 추가
        function deleteDataInRange() {
            if (recordedData.length === 0 || !rangeSlider.noUiSlider) return alert("삭제할 데이터가 없습니다.");
            const [startTime, endTime] = rangeSlider.noUiSlider.get().map(Number);
            
            const originalCount = recordedData.length;
            recordedData = recordedData.filter(d => d.time < startTime || d.time > endTime);
            const deletedCount = originalCount - recordedData.length;

            if (deletedCount === 0) return alert("선택된 범위에 삭제할 데이터가 없습니다.");

            alert(`${deletedCount}개의 데이터를 삭제했습니다.`);
            renderTable(); renderTrialList(); redrawChart(); createOrUpdateSlider();
        }

        function getVisibleTrials() {
            const trialsToShow = [];
            if (document.getElementById('currentTrialCheckbox')?.checked) {
                trialsToShow.push({ id: 'current', data: recordedData, name: '현재 측정' });
            }
            trialList.querySelectorAll('.trial-checkbox:checked').forEach(cb => trialsToShow.push(savedTrials[cb.id]));
            return trialsToShow;
        }

        function redrawChart() {
            const xKey = xAxisSelect.value;
            const yKey = yAxisSelect.value;
            myChart.options.scales.x.title.text = SENSOR_UNITS[xKey];
            myChart.options.scales.y.title.text = SENSOR_UNITS[yKey];

            myChart.data.datasets = [];
            const trialsToShow = getVisibleTrials();

            trialsToShow.forEach((trial, trialIndex) => {
                if (!trial || trial.data.length === 0) return;
                const color = TRIAL_COLORS[trialIndex % TRIAL_COLORS.length];
                myChart.data.datasets.push({
                    label: trial.name,
                    data: trial.data.map(d => ({ x: d[xKey], y: d[yKey] })),
                    borderColor: color, backgroundColor: color.replace('0.8)', '0.5)'),
                    showLine: true
                });
            });
            myChart.update();
        }

        function addTableRow(row, data) {
             row.innerHTML = `<td>${data.time.toFixed(2)}</td><td>${data.temp.toFixed(2)}</td><td>${data.humidity.toFixed(2)}</td><td>${data.pressure.toFixed(2)}</td><td>${data.light}</td>`;
        }
        
        function renderTable() {
            historyTbody.innerHTML = '';
            [...recordedData].reverse().forEach(d => {
                const row = historyTbody.insertRow(0);
                addTableRow(row, d);
            });
        }
        
        function downloadData() {
            if (recordedData.length === 0) return alert("다운로드할 데이터가 없습니다.");
            let csvContent = "data:text/csv;charset=utf-8,ID,Time (s),Temperature,Humidity,Pressure,Light,Timestamp (ms)\n";
            recordedData.forEach(d => {
                csvContent += `${d.id},${d.time.toFixed(3)},${d.temp.toFixed(2)},${d.humidity.toFixed(2)},${d.pressure.toFixed(2)},${d.light},${d.timestamp}\n`;
            });
            const link = document.createElement("a");
            link.href = encodeURI(csvContent);
            link.download = `env_data_${new Date().toISOString()}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function createOrUpdateSlider() {
            if (recordedData.length < 2) {
                if(rangeSlider.noUiSlider) rangeSlider.noUiSlider.destroy();
                rangeSlider.style.display = 'none';
                return;
            }
            
            const minTime = recordedData[0].time;
            const maxTime = recordedData[recordedData.length - 1].time;

            rangeSlider.style.display = 'block';
            if (rangeSlider.noUiSlider) {
                rangeSlider.noUiSlider.updateOptions({ range: { 'min': minTime, 'max': maxTime }, start: [minTime, maxTime] });
            } else {
                noUiSlider.create(rangeSlider, { start: [minTime, maxTime], connect: true, range: { 'min': minTime, 'max': maxTime } });
            }
        }
    });
    </script>
</body>
</html>
