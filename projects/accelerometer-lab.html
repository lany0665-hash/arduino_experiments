<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>가속도계 데이터 분석</title>
    
    <link rel="stylesheet" href="../css/style.css">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/regression/2.0.1/regression.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
</head>
<body>
    <div class="container">
        <a href="../index.html">&laquo; 메인 페이지로 돌아가기</a>
        <h1>가속도계 데이터 분석</h1>
        <p>상태: <span id="status">연결 대기</span></p>

        <div class="connection-section">
            <h3>연결 방식 선택</h3>
            <button id="collisionSimButton" class="sim-button">1. 자동차 충돌 시뮬레이션 시작</button>
            <hr>
            <button id="connectBleButton" class="ble-button">1. 아두이노(BLE) 연결</button>
        </div>

        <div class="simulation-area">
            <div class="car" id="simCar">CAR</div>
            <div class="explosion" id="simExplosion"></div>
            <div class="wall"></div>
        </div>

        <div class="button-group">
            <button id="recordButton" disabled>측정 시작/중지</button>
            <select id="samplingRateSelect">
                <option value="10">10ms (100 Hz)</option>
                <option value="100">100ms (10 Hz)</option>
                <option value="500">500ms (2 Hz)</option>
                <option value="1000" selected>1s (1 Hz)</option>
                <option value="2000">2s (0.5 Hz)</option>
            </select>
            <button id="downloadButton" disabled>엑셀 저장</button>
        </div>
        
        <div class="main-layout">
            <div class="content-column">
                <h2>측정 기록</h2>
                <div class="table-container">
                    <table id="historyTable">
                        <thead><tr><th>Timestamp</th><th>X</th><th>Y</th><th>Z</th></tr></thead>
                        <tbody id="historyTbody"></tbody>
                    </table>
                </div>
            </div>
            <div class="content-column">
                <h2>그래프 시각화 및 함수 피팅</h2>
                <div class="chart-wrapper">
                    <div class="chart-container"><canvas id="myChart"></canvas></div>
                    <div id="range-slider" style="display:none;"></div>
                </div>
                <div class="graph-controls">
                    <span>X축:</span>
                    <select id="xAxisSelect"><option value="Index">데이터 순서</option><option value="X">X</option><option value="Y">Y</option><option value="Z">Z</option></select>
                    <span>Y축:</span>
                    <select id="yAxisSelect"><option value="X">X</option><option value="Y">Y</option><option value="Z">Z</option></select>
                    <button id="resetZoomButton">줌 리셋</button>
                </div>
                 <div class="graph-controls fit-controls">
                    <span>피팅 범위: <b id="range-value"></b></span>
                    <select id="polynomialOrderSelect" style="margin-left: auto;">
                        <option value="1">1차</option><option value="2">2차</option><option value="3" selected>3차</option>
                    </select>
                    <button id="fitButton" disabled>함수 피팅</button>
                </div>
                <div class="fit-result">
                    <p>피팅 방정식: <span id="equation"></span></p>
                    <p><b>결정계수 (R²): <span id="r2_value"></span></b></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. UI 요소 및 전역 변수 선언 ---
        const connectBleButton = document.getElementById('connectBleButton');
        const collisionSimButton = document.getElementById('collisionSimButton');
        const recordButton = document.getElementById('recordButton');
        const downloadButton = document.getElementById('downloadButton');
        const fitButton = document.getElementById('fitButton');
        const statusSpan = document.getElementById('status');
        const equationSpan = document.getElementById('equation');
        const r2ValueSpan = document.getElementById('r2_value');
        const historyTbody = document.getElementById('historyTbody');
        const xAxisSelect = document.getElementById('xAxisSelect');
        const yAxisSelect = document.getElementById('yAxisSelect');
        const samplingRateSelect = document.getElementById('samplingRateSelect');
        const resetZoomButton = document.getElementById('resetZoomButton');
        const chartCanvas = document.getElementById('myChart');
        const polynomialOrderSelect = document.getElementById('polynomialOrderSelect');
        const rangeSlider = document.getElementById('range-slider');
        const rangeValue = document.getElementById('range-value');
        const simCar = document.getElementById('simCar');
        const simExplosion = document.getElementById('simExplosion');

        let recordedData = []; 
        let isRecording = false;
        let collisionSimulationInterval;
        let samplingIntervalMs = 100;
        let lastSampleTime = 0;
        let myChart;
        let lastGraphUpdateTime = 0;

        // --- 2. 차트 초기화 ---
        myChart = new Chart(chartCanvas, { /* 이전과 동일 */ });

        // --- 3. 이벤트 리스너 연결 ---
        collisionSimButton.addEventListener('click', startCollisionSimulation);
        connectBleButton.addEventListener('click', async () => { /* 이전과 동일 */ });
        samplingRateSelect.addEventListener('change', (event) => { samplingIntervalMs = parseInt(event.target.value); });
        recordButton.addEventListener('click', () => { isRecording = !isRecording; /* 일부 UI 로직만 수행 */ });
        resetZoomButton.addEventListener('click', () => myChart.resetZoom());
        fitButton.addEventListener('click', fitPolynomialToRange);
        downloadButton.addEventListener('click', downloadSelectedData);
        xAxisSelect.addEventListener('change', () => { updateGraphAxes(); if(rangeSlider.noUiSlider) createOrUpdateSlider(); });
        yAxisSelect.addEventListener('change', updateGraphAxes);
        
        // --- 4. 함수 정의 ---
        function onDataReceived(x, y, z) { const now = Date.now(); if (now - lastSampleTime >= samplingIntervalMs) { lastSampleTime = now; processAndDisplayData(x, y, z); } }
        function handleBleNotifications(event) { /* 이전과 동일 */ }
        
        function processAndDisplayData(x, y, z) {
            if (isRecording) {
                const timestamp = new Date().toISOString();
                const currentData = [timestamp, parseFloat(x), parseFloat(y), parseFloat(z)];
                recordedData.push(currentData);
                const newRow = historyTbody.insertRow(0);
                newRow.innerHTML = `<td>${currentData[0]}</td><td>${currentData[1].toFixed(4)}</td><td>${currentData[2].toFixed(4)}</td><td>${currentData[3].toFixed(4)}</td>`;
                updateGraphAxes();
            }
        }
        
        function updateGraphAxes() { /* 이전과 동일 */ }
        function alignSliderWithChart() { /* 이전과 동일 */ }
        new ResizeObserver(alignSliderWithChart).observe(chartCanvas);
        function createOrUpdateSlider() { /* 이전과 동일 */ }
        function fitPolynomialToRange() { /* 이전과 동일 */ }
        function downloadSelectedData() { /* 이전과 동일 */ }

        // --- 5. 새로운 충돌 시뮬레이션 로직 ---
        function startCollisionSimulation() {
            // 초기화
            if (collisionSimulationInterval) clearInterval(collisionSimulationInterval);
            statusSpan.textContent = "시뮬레이션 준비 중...";
            connectBleButton.disabled = true;
            collisionSimButton.disabled = true;
            isRecording = false; // 측정 상태 초기화
            recordedData = []; 
            historyTbody.innerHTML = '';
            myChart.data.datasets[0].data = [];
            myChart.data.datasets[1].data = [];
            myChart.update('none');

            let currentX = 0; // 자동차 현재 위치
            const carSpeed = 8; // 자동차 속도 증가
            const parentWidth = simCar.parentElement.offsetWidth;
            const wallX = parentWidth - simCar.offsetWidth - 10; // 벽 위치
            const proximityZone = wallX * 0.8; // 80% 지점에서 '근접' 상태로 변경
            let state = 'approaching'; // 현재 상태: approaching -> proximity -> collision -> finished

            collisionSimulationInterval = setInterval(() => {
                let accX = 0, accY = 0, accZ = 9.8;

                if (state === 'approaching') {
                    currentX += carSpeed;
                    simCar.style.transform = `translateX(${currentX}px)`;
                    if (currentX >= proximityZone) {
                        state = 'proximity';
                        statusSpan.textContent = "근접";
                        isRecording = true; // '근접' 상태에서 데이터 기록 자동 시작
                        lastSampleTime = 0; // 샘플링 타이머 초기화
                    }
                }
                
                if (state === 'proximity') {
                    currentX += carSpeed;
                    simCar.style.transform = `translateX(${currentX}px)`;
                    accX = 0.5 + Math.random() * 0.1; // 등속 운동에 가까운 가속도
                    onDataReceived(accX, accY, accZ); // 데이터 생성

                    if (currentX >= wallX) {
                        state = 'collision';
                        simCar.style.transform = `translateX(${wallX}px)`; // 벽에 정확히 붙임
                        statusSpan.textContent = "충돌!";
                        
                        // 충돌 이펙트
                        simExplosion.style.left = `${wallX - simCar.offsetWidth / 2}px`;
                        simExplosion.style.bottom = `${simCar.offsetHeight / 2}px`;
                        simExplosion.classList.add('active');

                        // 0.01초(10ms) 동안의 충돌 데이터 생성 (가우시안 형태 모사)
                        // 정규분포의 확률밀도함수 모양을 흉내 내어 충돌 스파이크 생성
                        const peakImpact = -200; // 최대 충격 가속도
                        const collisionTimeStep = 0.002; // 0.01초를 5단계로 나눔
                        for (let t = -0.004; t <= 0.004; t += collisionTimeStep) {
                            // 가우시안 함수: exp(-t^2 / (2*sigma^2))
                            let scale = Math.exp(-Math.pow(t / 0.002, 2) / 2);
                            accX = peakImpact * scale + (Math.random()-0.5);
                            accY = (Math.random() - 0.5) * 20 * scale;
                            accZ = 9.8 + (Math.random() - 0.5) * 10 * scale;
                            onDataReceived(accX, accY, accZ);
                        }

                        // 충돌 후 약간의 반동
                        setTimeout(() => {
                           simCar.style.transform = `translateX(${wallX - 15}px)`;
                           simExplosion.classList.remove('active');
                           state = 'finished';
                        }, 50); 
                    }
                }

                if (state === 'finished') {
                    isRecording = false; // 기록 중지
                    clearInterval(collisionSimulationInterval);
                    statusSpan.textContent = "시뮬레이션 완료";
                    collisionSimButton.disabled = false;
                    connectBleButton.disabled = false;
                    downloadButton.disabled = false;
                    fitButton.disabled = false;
                    createOrUpdateSlider();
                }
            }, 20); // 애니메이션 프레임 속도 (ms)
        }
    </script>
</body>
</html>
