#include <ArduinoBLE.h>
#include <Arduino_BMI270_BMM150.h>
#include <Arduino_HS300x.h>
#include <Arduino_APDS9960.h>
#include <Arduino_LPS22HB.h>
#include "mbed.h"

// BLE 설정
BLEService mainService("19B10000-E8F2-537E-4F6C-D104768A1214");
BLECharacteristic dataCharacteristic("19B10001-E8F2-537E-4F6C-D104768A1214", BLERead | BLENotify, 300);
BLECharacteristic commandCharacteristic("19B10002-E8F2-537E-4F6C-D104768A1214", BLEWrite, 20);

// 작동 모드
enum OperatingMode { MODE_IDLE, MODE_IMU, MODE_ENV };
OperatingMode currentMode = MODE_IDLE;

// IMU 샘플링 관련
mbed::Ticker imuSampler;
volatile bool sampleImuFlag = false;
int imuSampleIntervalMs = 10;
const int NUM_READINGS = 5;
float readingsX[NUM_READINGS], readingsY[NUM_READINGS], readingsZ[NUM_READINGS];
int readIndex = 0;
float totalX = 0, totalY = 0, totalZ = 0;
const int IMU_SEND_INTERVAL_MS = 50;
unsigned long lastImuSendTime = 0;

char imuDataBuffer[300];
int bufferIndex = 0;

// 환경 센서 샘플링 관련
int envSampleIntervalMs = 1000;
unsigned long lastEnvSampleTime = 0;
int lastLightValue = 0;

// IMU 샘플링 플래그 설정 함수
void setImuSampleFlag() {
  sampleImuFlag = true;
}

void setup() {
  Serial.begin(115200);
  
  // 센서 초기화
  if (!IMU.begin() || !HS300x.begin() || !APDS.begin() || !BARO.begin()) {
    Serial.println("Failed to initialize sensors!");
    while (1);
  }

  if (!BLE.begin()) {
    Serial.println("starting BLE failed!");
    while (1);
  }

  // BLE 장치 이름 설정
  String bleAddress = BLE.address();
  String uniqueID = bleAddress.substring(bleAddress.length() - 5);
  uniqueID.toUpperCase();
  String localName = "Sensor-" + uniqueID;
  BLE.setLocalName(localName.c_str());

  // BLE 서비스 및 특성 설정
  BLE.setAdvertisedService(mainService);
  mainService.addCharacteristic(dataCharacteristic);
  mainService.addCharacteristic(commandCharacteristic);
  BLE.addService(mainService);
  BLE.advertise();
  
  Serial.print("Bluetooth device active: ");
  Serial.println(localName);
}

void loop() {
  BLE.poll();
  unsigned long currentTime = millis();

  // 1. 웹페이지로부터 명령 수신
  if (commandCharacteristic.written()) {
    char cmdBuffer[21];
    int len = commandCharacteristic.readValue(cmdBuffer, 20);
    cmdBuffer[len] = '\0';
    String command = String(cmdBuffer);

    if (command == "START:IMU") {
      currentMode = MODE_IMU;
      imuSampler.attach(setImuSampleFlag, std::chrono::milliseconds(imuSampleIntervalMs));
    } else if (command == "START:ENV") {
      currentMode = MODE_ENV;
      imuSampler.detach();
    } else if (command == "STOP") {
      currentMode = MODE_IDLE;
      imuSampler.detach();
    } else if (command.startsWith("SET_IMU_RATE:")) {
      int rate = command.substring(13).toInt();
      if (rate == 200) imuSampleIntervalMs = 5;
      else if (rate == 100) imuSampleIntervalMs = 10;
      else if (rate == 25) imuSampleIntervalMs = 40;
      
      if (currentMode == MODE_IMU) {
        imuSampler.detach();
        imuSampler.attach(setImuSampleFlag, std::chrono::milliseconds(imuSampleIntervalMs));
      }
    } else if (command.startsWith("SET_ENV_RATE:")) {
      envSampleIntervalMs = command.substring(13).toInt();
    }
  }

  // 2. IMU 모드일 때의 동작
  if (currentMode == MODE_IMU) {
    if (sampleImuFlag) {
      sampleImuFlag = false;
      float x, y, z;
      if (IMU.accelerationAvailable()) {
        IMU.readAcceleration(x, y, z);
        totalX -= readingsX[readIndex]; totalY -= readingsY[readIndex]; totalZ -= readingsZ[readIndex];
        readingsX[readIndex] = x; readingsY[readIndex] = y; readingsZ[readIndex] = z;
        totalX += x; totalY += y; totalZ += z;
        readIndex = (readIndex + 1) % NUM_READINGS;
        
        float avgX = totalX / NUM_READINGS;
        float avgY = totalY / NUM_READINGS;
        float avgZ = totalZ / NUM_READINGS;
        
        if (bufferIndex < sizeof(imuDataBuffer) - 40) {
          int written = snprintf(imuDataBuffer + bufferIndex, sizeof(imuDataBuffer) - bufferIndex,
                                 "%lu,%.4f,%.4f,%.4f;",
                                 millis(), avgX, avgY, avgZ);
          if (written > 0) {
            bufferIndex += written;
          }
        }
      }
    }
    
    if (currentTime - lastImuSendTime >= IMU_SEND_INTERVAL_MS) {
      lastImuSendTime = currentTime;
      if (BLE.connected() && bufferIndex > 0) {
        dataCharacteristic.writeValue((const uint8_t*)imuDataBuffer, bufferIndex);
        bufferIndex = 0;
      }
    }
  }
  
  // 3. 환경 센서 모드일 때의 동작
  else if (currentMode == MODE_ENV) {
    if (currentTime - lastEnvSampleTime >= envSampleIntervalMs) {
      lastEnvSampleTime = currentTime;
      if (BLE.connected()) {
        float temp = HS300x.readTemperature();
        float humidity = HS300x.readHumidity();
        float pressure = BARO.readPressure();
        
        if (APDS.colorAvailable()) {
          int r, g, b, a;
          APDS.readColor(r, g, b, a);
          lastLightValue = a;
        }
        
        String json = "{\"type\":\"env\",\"data\":{\"temp\":" + String(temp) + ",\"humidity\":" + String(humidity) + ",\"pressure\":" + String(pressure) + ",\"light\":" + String(lastLightValue) + "}}";
        dataCharacteristic.writeValue(json.c_str());
      }
    }
  }
}
