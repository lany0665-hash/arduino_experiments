<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê°€ì†ë„ê³„ ë°ì´í„° ë¶„ì„</title>
    
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/regression/2.0.1/regression.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    <style>
        /* ì²´í¬ë°•ìŠ¤ ê·¸ë£¹ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .checkbox-group { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .checkbox-group label { display: flex; align-items: center; gap: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <a href="../index.html">&laquo; ë©”ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a>
        <h1>ê°€ì†ë„ê³„ ë°ì´í„° ë¶„ì„</h1>
        <p>ìƒíƒœ: <span id="status">ì—°ê²° ëŒ€ê¸°</span></p>

        <div class="connection-section">
            <h3>ì—°ê²° ë°©ì‹ ì„ íƒ</h3>
            <button id="collisionSimButton" class="sim-button">1. ìë™ì°¨ ì¶©ëŒ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘</button>
            <hr>
            <button id="connectBleButton" class="ble-button">1. ì•„ë‘ì´ë…¸(BLE) ì—°ê²°</button>
        </div>

        <div class="button-group">
            <button id="recordButton" disabled>2. ì¸¡ì • ì‹œì‘</button>
            <select id="samplingRateSelect">
                <option value="200">5ms (200 Hz)</option>
                <option value="100" selected>10ms (100 Hz)</option>
                <option value="25">40ms (25 Hz)</option>
            </select>
            <button id="downloadButton" disabled>3. ì—‘ì…€ ì €ì¥</button>
        </div>
        
        <div class="main-layout">
            <div class="content-column">
                <h2>ì¸¡ì • ê¸°ë¡</h2>
                <div class="table-container">
                    <table id="historyTable">
                        <thead><tr><th>Time (s)</th><th>X</th><th>Y</th><th>Z</th><th>Total</th></tr></thead>
                        <tbody id="historyTbody"></tbody>
                    </table>
                </div>
            </div>
            <div class="content-column">
                <h2>ê·¸ë˜í”„ ì‹œê°í™” ë° í•¨ìˆ˜ í”¼íŒ…</h2>
                <div class="chart-wrapper">
                    <div class="chart-container"><canvas id="myChart"></canvas></div>
                    <div id="range-slider" style="display:none;"></div>
                </div>
                <div class="graph-controls">
                    <span>Yì¶• ì„ íƒ:</span>
                    <div id="yAxisCheckboxGroup" class="checkbox-group">
                        <label><input type="checkbox" name="yAxis" value="X" checked> X</label>
                        <label><input type="checkbox" name="yAxis" value="Y" checked> Y</label>
                        <label><input type="checkbox" name="yAxis" value="Z" checked> Z</label>
                        <label><input type="checkbox" name="yAxis" value="Total"> Total</label>
                    </div>
                    <button id="resetZoomButton" style="margin-left: auto;">ì¤Œ ë¦¬ì…‹</button>
                </div>
                 <div class="graph-controls fit-controls">
                    <span>í”¼íŒ… ë²”ìœ„: <b id="range-value"></b></span>
                    <select id="fitTargetSelect" style="margin-left: auto;">
                        <option value="X">X ê¸°ì¤€</option>
                        <option value="Y">Y ê¸°ì¤€</option>
                        <option value="Z">Z ê¸°ì¤€</option>
                        <option value="Total">Total ê¸°ì¤€</option>
                    </select>
                    <select id="polynomialOrderSelect">
                        <option value="1">1ì°¨</option><option value="2">2ì°¨</option><option value="3" selected>3ì°¨</option>
                    </select>
                    <button id="fitButton" disabled>í•¨ìˆ˜ í”¼íŒ…</button>
                </div>
                <div class="fit-result">
                    <p>í”¼íŒ… ë°©ì •ì‹: <span id="equation"></span></p>
                    <p><b>ê²°ì •ê³„ìˆ˜ (RÂ²): <span id="r2_value"></span></b></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. UI ìš”ì†Œ ë° ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ ---
        const connectBleButton = document.getElementById('connectBleButton');
        const recordButton = document.getElementById('recordButton');
        const downloadButton = document.getElementById('downloadButton');
        const fitButton = document.getElementById('fitButton');
        const statusSpan = document.getElementById('status');
        const equationSpan = document.getElementById('equation');
        const r2ValueSpan = document.getElementById('r2_value');
        const historyTbody = document.getElementById('historyTbody');
        const yAxisCheckboxGroup = document.getElementById('yAxisCheckboxGroup');
        const samplingRateSelect = document.getElementById('samplingRateSelect');
        const resetZoomButton = document.getElementById('resetZoomButton');
        const chartCanvas = document.getElementById('myChart');
        const polynomialOrderSelect = document.getElementById('polynomialOrderSelect');
        const fitTargetSelect = document.getElementById('fitTargetSelect');
        const rangeSlider = document.getElementById('range-slider');
        const rangeValue = document.getElementById('range-value');

        let recordedData = []; 
        let isRecording = false;
        let samplingIntervalMs = 10;
        let myChart;
        let commandCharacteristic;

        const UART_SERVICE_UUID = "19b10000-e8f2-537e-4f6c-d104768a1214";
        const UART_TX_CHAR_UUID = "19b10001-e8f2-537e-4f6c-d104768a1214";
        const UART_CMD_CHAR_UUID = "19b10002-e8f2-537e-4f6c-d104768a1214";
        
        const DATASET_MAP = {
            'X': { index: 0, color: 'rgba(255, 99, 132, 0.8)' },
            'Y': { index: 1, color: 'rgba(54, 162, 235, 0.8)' },
            'Z': { index: 2, color: 'rgba(75, 192, 192, 0.8)' },
            'Total': { index: 3, color: 'rgba(153, 102, 255, 0.8)' },
            'Fit': { index: 4, color: 'rgba(255, 159, 64, 1)' }
        };

        // --- 2. ì°¨íŠ¸ ì´ˆê¸°í™” ---
        myChart = new Chart(chartCanvas, {
            type: 'scatter',
            data: {
                datasets: [
                    { label: 'X', data: [], borderColor: DATASET_MAP.X.color, backgroundColor: DATASET_MAP.X.color, showLine: true, tension: 0.1, pointRadius: 1 },
                    { label: 'Y', data: [], borderColor: DATASET_MAP.Y.color, backgroundColor: DATASET_MAP.Y.color, showLine: true, tension: 0.1, pointRadius: 1 },
                    { label: 'Z', data: [], borderColor: DATASET_MAP.Z.color, backgroundColor: DATASET_MAP.Z.color, showLine: true, tension: 0.1, pointRadius: 1 },
                    { label: 'Total', data: [], borderColor: DATASET_MAP.Total.color, backgroundColor: DATASET_MAP.Total.color, showLine: true, tension: 0.1, pointRadius: 1 },
                    { label: 'í•¨ìˆ˜ í”¼íŒ…', data: [], borderColor: DATASET_MAP.Fit.color, type: 'line', fill: false, tension: 0.1, pointRadius: 0 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { x: { type: 'linear', position: 'bottom', title: { display: true, text: 'Time (s)' } }, y: { title: { display: true, text: 'Acceleration (G)' } } },
                plugins: {
                    zoom: { pan: { enabled: true, mode: 'xy' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'xy' } },
                    annotation: {
                        annotations: {
                            startLine: { type: 'line', scaleID: 'x', value: 0, borderColor: 'rgba(255, 99, 132, 0.8)', borderWidth: 2, borderDash: [6, 6], display: false },
                            endLine: { type: 'line', scaleID: 'x', value: 0, borderColor: 'rgba(255, 99, 132, 0.8)', borderWidth: 2, borderDash: [6, 6], display: false }
                        }
                    }
                }
            }
        });
        
        // ğŸ”¹ ë³€ê²½ì : í˜ì´ì§€ ë¡œë“œ ì‹œ ê·¸ë˜í”„ í‘œì‹œ ìƒíƒœë¥¼ ì²´í¬ë°•ìŠ¤ì™€ ë™ê¸°í™”
        updateGraphVisibility();

        // --- 3. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ---
        connectBleButton.addEventListener('click', connectBLE);
        samplingRateSelect.addEventListener('change', handleRateChange);
        recordButton.addEventListener('click', toggleRecording);
        resetZoomButton.addEventListener('click', () => myChart.resetZoom());
        fitButton.addEventListener('click', fitPolynomialToRange);
        downloadButton.addEventListener('click', downloadData);
        yAxisCheckboxGroup.addEventListener('change', updateGraphVisibility);

        // --- 4. í•¨ìˆ˜ ì •ì˜ ---
        async function connectBLE() {
            try {
                const device = await navigator.bluetooth.requestDevice({ filters: [{ services: [UART_SERVICE_UUID], namePrefix: 'Sensor-' }] }); 
                statusSpan.textContent = `ì—°ê²° ì¤‘: ${device.name}`; 
                const server = await device.gatt.connect(); 
                const service = await server.getPrimaryService(UART_SERVICE_UUID); 
                const dataCharacteristic = await service.getCharacteristic(UART_TX_CHAR_UUID);
                commandCharacteristic = await service.getCharacteristic(UART_CMD_CHAR_UUID);
                await dataCharacteristic.startNotifications(); 
                dataCharacteristic.addEventListener('characteristicvaluechanged', handleBleNotifications); 
                statusSpan.textContent = `ì—°ê²°ë¨: ${device.name}`; 
                connectBleButton.disabled = true; 
                recordButton.disabled = false;
                handleRateChange();
            } catch (error) { 
                console.error('BLE ì—°ê²° ì‹¤íŒ¨:', error); 
                statusSpan.textContent = 'BLE ì—°ê²° ì‹¤íŒ¨'; 
            } 
        }

        function handleRateChange() {
            const selectedHz = parseInt(samplingRateSelect.value);
            if (selectedHz === 200) samplingIntervalMs = 5;
            else if (selectedHz === 100) samplingIntervalMs = 10;
            else if (selectedHz === 25) samplingIntervalMs = 40;
            sendRateCommand();
        }

        async function sendRateCommand() {
            if (!commandCharacteristic) return;
            const command = `SET_RATE:${samplingRateSelect.value}`;
            try {
                await commandCharacteristic.writeValue(new TextEncoder().encode(command));
            } catch (error) { console.error(`ëª…ë ¹ ì „ì†¡ ì‹¤íŒ¨: ${command}`, error); }
        }

        function toggleRecording() {
            isRecording = !isRecording;
            if (isRecording) {
                recordedData = []; historyTbody.innerHTML = '';
                Object.values(DATASET_MAP).forEach(d => {
                    if (myChart.data.datasets[d.index]) myChart.data.datasets[d.index].data = [];
                });
                myChart.update('none');
                equationSpan.textContent = ''; r2ValueSpan.textContent = ''; 
                recordButton.textContent = 'ì¸¡ì • ì¤‘ì§€'; recordButton.style.backgroundColor = '#DC3545'; 
                downloadButton.disabled = true; fitButton.disabled = true;
                if (rangeSlider.noUiSlider) rangeSlider.noUiSlider.destroy();
                rangeSlider.style.display = 'none';
                statusSpan.textContent = 'ì¸¡ì • ì¤‘...';
            } else {
                recordButton.textContent = 'ì¸¡ì • ì‹œì‘'; recordButton.style.backgroundColor = '#28A745'; statusSpan.textContent = 'ì¸¡ì • ì™„ë£Œ';
                if (recordedData.length > 0) { 
                    downloadButton.disabled = false; fitButton.disabled = false;
                    createOrUpdateSlider(); 
                }
            }
        }

        function handleBleNotifications(event) {
            if (!isRecording) return;
            const batchString = new TextDecoder().decode(event.target.value);
            const dataPackets = batchString.split(';').filter(p => p);

            dataPackets.forEach(packet => {
                const [xStr, yStr, zStr] = packet.split(',');
                const x = parseFloat(xStr), y = parseFloat(yStr), z = parseFloat(zStr);
                const total = Math.sqrt(x*x + y*y + z*z);
                const elapsedTime = (recordedData.length * samplingIntervalMs) / 1000.0;
                
                const currentData = [elapsedTime, x, y, z, total];
                recordedData.push(currentData);

                const newRow = historyTbody.insertRow(0);
                newRow.innerHTML = `<td>${elapsedTime.toFixed(3)}</td><td>${x.toFixed(4)}</td><td>${y.toFixed(4)}</td><td>${z.toFixed(4)}</td><td>${total.toFixed(4)}</td>`;
            });
            updateGraphData();
        }
        
        function updateGraphData() {
            const timeData = recordedData.map(row => row[0]);
            const xData = recordedData.map(row => row[1]);
            const yData = recordedData.map(row => row[2]);
            const zData = recordedData.map(row => row[3]);
            const totalData = recordedData.map(row => row[4]);

            myChart.data.datasets[DATASET_MAP.X.index].data = timeData.map((t, i) => ({x: t, y: xData[i]}));
            myChart.data.datasets[DATASET_MAP.Y.index].data = timeData.map((t, i) => ({x: t, y: yData[i]}));
            myChart.data.datasets[DATASET_MAP.Z.index].data = timeData.map((t, i) => ({x: t, y: zData[i]}));
            myChart.data.datasets[DATASET_MAP.Total.index].data = timeData.map((t, i) => ({x: t, y: totalData[i]}));
            
            myChart.update('none');
        }

        function updateGraphVisibility() {
            const checkboxes = yAxisCheckboxGroup.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                const datasetIndex = DATASET_MAP[cb.value].index;
                myChart.data.datasets[datasetIndex].hidden = !cb.checked;
            });
            myChart.update();
        }

        function createOrUpdateSlider() {
            const xData = recordedData.map(row => row[0]);
            if (xData.length === 0) return;
            const minX = Math.min(...xData), maxX = Math.max(...xData);
            
            rangeSlider.style.display = 'block';
            if (rangeSlider.noUiSlider) {
                rangeSlider.noUiSlider.updateOptions({ range: { 'min': minX, 'max': maxX }, start: [minX, maxX] });
            } else {
                noUiSlider.create(rangeSlider, { start: [minX, maxX], connect: true, range: { 'min': minX, 'max': maxX } });
            }
            rangeSlider.noUiSlider.on('update', (values) => {
                const [startVal, endVal] = [parseFloat(values[0]), parseFloat(values[1])];
                rangeValue.textContent = `${startVal.toFixed(3)} ~ ${endVal.toFixed(3)}`;
                myChart.options.plugins.annotation.annotations.startLine.value = startVal;
                myChart.options.plugins.annotation.annotations.startLine.display = true;
                myChart.options.plugins.annotation.annotations.endLine.value = endVal;
                myChart.options.plugins.annotation.annotations.endLine.display = true;
                myChart.update('none');
            });
        }

        function fitPolynomialToRange() {
            if (!rangeSlider.noUiSlider) { alert('ë°ì´í„°ë¥¼ ë¨¼ì € ì¸¡ì •í•´ì£¼ì„¸ìš”.'); return; }
            const order = parseInt(polynomialOrderSelect.value);
            const [startX, endX] = rangeSlider.noUiSlider.get().map(parseFloat);
            if (startX >= endX) { alert("ìœ íš¨í•œ ë²”ìœ„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
            
            const fitTarget = fitTargetSelect.value;
            const colMap = { 'Time': 0, 'X': 1, 'Y': 2, 'Z': 3, 'Total': 4 };
            const yIndex = colMap[fitTarget];

            const dataForFitting = recordedData
                .filter(row => row[0] >= startX && row[0] <= endX)
                .map(row => [row[0], row[yIndex]]);
            
            if (dataForFitting.length < order + 1) { alert(`${order}ì°¨ í•¨ìˆ˜ í”¼íŒ…ì„ ìœ„í•´ ìµœì†Œ ${order + 1}ê°œì˜ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.`); return; }
            
            const result = regression.polynomial(dataForFitting, { order: order, precision: 5 });
            equationSpan.textContent = result.string;
            r2ValueSpan.textContent = result.r2.toFixed(4);
            
            const fitDataset = myChart.data.datasets[DATASET_MAP.Fit.index];
            fitDataset.data = result.points.map(p => ({x: p[0], y: p[1]}));
            fitDataset.label = `${fitTarget} ${order}ì°¨ í”¼íŒ… (RÂ²=${result.r2.toFixed(4)})`;
            myChart.update();
        }

        function downloadData() {
            if (recordedData.length === 0) { alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += "Time(s),X,Y,Z,Total\r\n";
            recordedData.forEach(row => { 
                csvContent += row.map(val => val.toFixed(4)).join(",") + "\r\n"; 
            });
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "sensor_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
